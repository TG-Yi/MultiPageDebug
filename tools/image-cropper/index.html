<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <title>å›¾ç‰‡è£å‰ªå·¥å…· - åœ¨çº¿å›¾ç‰‡ç¼–è¾‘å™¨</title>
    <link rel="stylesheet" href="../../shared/styles/reset.css" />
    <link rel="stylesheet" href="../../shared/styles/theme.css" />
    <link rel="stylesheet" href="../../shared/styles/common.css" />
    <style>
      :root {
        --primary-color: #8b5cf6;
        --primary-hover: #7c3aed;
        --secondary-color: #ec4899;
        --accent-color: #f59e0b;
        --success-color: #10b981;
        --text-color: #1f2937;
        --text-light: #6b7280;
        --bg-light: #f9fafb;
        --border-color: #e5e7eb;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(
          135deg,
          #667eea 0%,
          #764ba2 50%,
          #f093fb 100%
        );
        min-height: 100vh;
        height: 100vh;
        padding: 20px;
        overflow: hidden;
      }

      .main-container {
        max-width: 1600px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        height: calc(100vh - 40px);
        overflow: hidden;
      }

      /* å¤´éƒ¨ */
      .header {
        text-align: center;
        color: white;
        padding: 10px 20px;
        flex-shrink: 0;
      }

      .header h1 {
        font-size: 28px;
        font-weight: 700;
        margin-bottom: 6px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 13px;
        opacity: 0.9;
      }

      /* å·¥ä½œåŒº */
      .workspace {
        display: grid;
        grid-template-columns: minmax(280px, 320px) 1fr minmax(280px, 320px);
        gap: 20px;
        flex: 1;
        min-height: 0;
        overflow: hidden;
      }

      /* å·¦ä¾§å·¥å…·æ  */
      .toolbar {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .tool-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .tool-section-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-color);
        margin-bottom: 5px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .tool-btn {
        padding: 12px 16px;
        background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
        border: none;
        border-radius: 10px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        -webkit-tap-highlight-color: transparent;
      }

      .tool-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(139, 92, 246, 0.4);
      }

      .tool-btn:active {
        transform: translateY(0);
      }

      .tool-btn.secondary {
        background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
      }

      .tool-btn.secondary:hover {
        box-shadow: 0 6px 16px rgba(107, 114, 128, 0.4);
      }

      .tool-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
        transform: none !important;
      }

      /* è£å‰ªæ¯”ä¾‹æŒ‰é’®ç»„ */
      .ratio-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .ratio-btn {
        padding: 10px;
        background: rgba(139, 92, 246, 0.1);
        border: 2px solid rgba(139, 92, 246, 0.2);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 13px;
        font-weight: 500;
        color: var(--text-color);
        text-align: center;
      }

      .ratio-btn:hover {
        background: rgba(139, 92, 246, 0.2);
        border-color: var(--primary-color);
      }

      .ratio-btn.active {
        background: var(--primary-color);
        color: white;
        border-color: var(--primary-color);
      }

      /* æ»‘å—æ§åˆ¶ */
      .slider-control {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .slider-label {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 13px;
        color: var(--text-light);
      }

      .slider-value {
        font-weight: 600;
        color: var(--primary-color);
      }

      input[type="range"] {
        width: 100%;
        height: 6px;
        border-radius: 3px;
        background: #e5e7eb;
        outline: none;
        -webkit-appearance: none;
      }

      input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        appearance: none;
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        transition: all 0.2s ease;
      }

      input[type="range"]::-webkit-slider-thumb:hover {
        transform: scale(1.2);
        box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.2);
      }

      input[type="range"]::-moz-range-thumb {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        background: var(--primary-color);
        cursor: pointer;
        border: none;
      }

      /* æ»¤é•œæŒ‰é’®ç»„ */
      .filter-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
      }

      .filter-btn {
        padding: 8px;
        background: white;
        border: 2px solid var(--border-color);
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 12px;
        text-align: center;
        color: var(--text-color);
      }

      .filter-btn:hover {
        border-color: var(--primary-color);
        background: rgba(139, 92, 246, 0.05);
      }

      .filter-btn.active {
        border-color: var(--primary-color);
        background: var(--primary-color);
        color: white;
      }

      /* ä¸­é—´ç”»å¸ƒåŒºåŸŸ */
      .canvas-area {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        overflow: auto;
      }

      /* ä¸Šä¼ åŒºåŸŸ */
      .upload-area {
        width: 100%;
        max-width: 600px;
        padding: 60px 40px;
        border: 3px dashed var(--border-color);
        border-radius: 16px;
        text-align: center;
        cursor: pointer;
        transition: all 0.3s ease;
        background: var(--bg-light);
      }

      .upload-area:hover {
        border-color: var(--primary-color);
        background: rgba(139, 92, 246, 0.05);
      }

      .upload-area.dragging {
        border-color: var(--primary-color);
        background: rgba(139, 92, 246, 0.1);
        transform: scale(1.02);
      }

      .upload-icon {
        font-size: 64px;
        margin-bottom: 20px;
        opacity: 0.5;
      }

      .upload-text {
        font-size: 18px;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 8px;
      }

      .upload-hint {
        font-size: 14px;
        color: var(--text-light);
      }

      #fileInput {
        display: none;
      }

      /* Canvaså®¹å™¨ */
      .canvas-container {
        display: none;
        width: 100%;
        height: 100%;
        position: relative;
        overflow: hidden;
      }

      .canvas-container.active {
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .canvas-wrapper {
        position: relative;
        max-width: 100%;
        max-height: 100%;
        overflow: auto;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #canvas {
        display: block;
        max-width: 100%;
        height: auto;
        border-radius: 8px;
        transition: all 0.3s ease;
      }

      /* è£å‰ªæ¡† */
      .crop-box {
        position: absolute;
        border: 2px solid var(--primary-color);
        box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
        cursor: move;
        display: none;
        z-index: 10;
      }

      .crop-box.active {
        display: block;
      }

      /* è£å‰ªæ¡†ä¹å®«æ ¼å‚è€ƒçº¿ (Rule of Thirds) */
      /* ç”¨äºè¾…åŠ©æ„å›¾,éµå¾ªæ‘„å½±ä¸‰åˆ†æ³•åˆ™ */
      .crop-box::before,
      .crop-box::after {
        content: '';
        position: absolute;
        pointer-events: none;
      }

      /* ä¸¤æ¡ç«–çº¿ */
      .crop-box::before {
        left: 0;
        top: 0;
        bottom: 0;
        width: 100%;
        background:
          linear-gradient(90deg, transparent 33.33%, rgba(255, 255, 255, 0.3) 33.33%, rgba(255, 255, 255, 0.3) calc(33.33% + 1px), transparent calc(33.33% + 1px)),
          linear-gradient(90deg, transparent 66.66%, rgba(255, 255, 255, 0.3) 66.66%, rgba(255, 255, 255, 0.3) calc(66.66% + 1px), transparent calc(66.66% + 1px));
      }

      /* ä¸¤æ¡æ¨ªçº¿ */
      .crop-box::after {
        left: 0;
        top: 0;
        right: 0;
        height: 100%;
        background:
          linear-gradient(0deg, transparent 33.33%, rgba(255, 255, 255, 0.3) 33.33%, rgba(255, 255, 255, 0.3) calc(33.33% + 1px), transparent calc(33.33% + 1px)),
          linear-gradient(0deg, transparent 66.66%, rgba(255, 255, 255, 0.3) 66.66%, rgba(255, 255, 255, 0.3) calc(66.66% + 1px), transparent calc(66.66% + 1px));
      }

      .crop-handle {
        position: absolute;
        width: 14px;
        height: 14px;
        background: white;
        border: 2px solid var(--primary-color);
        border-radius: 50%;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        transition: transform 0.2s ease;
        z-index: 11;
      }

      .crop-handle:hover {
        transform: scale(1.3);
      }

      .crop-handle.nw { top: -6px; left: -6px; cursor: nw-resize; }
      .crop-handle.ne { top: -6px; right: -6px; cursor: ne-resize; }
      .crop-handle.sw { bottom: -6px; left: -6px; cursor: sw-resize; }
      .crop-handle.se { bottom: -6px; right: -6px; cursor: se-resize; }
      .crop-handle.n { top: -6px; left: 50%; margin-left: -6px; cursor: n-resize; }
      .crop-handle.s { bottom: -6px; left: 50%; margin-left: -6px; cursor: s-resize; }
      .crop-handle.w { top: 50%; left: -6px; margin-top: -6px; cursor: w-resize; }
      .crop-handle.e { top: 50%; right: -6px; margin-top: -6px; cursor: e-resize; }

      /* å³ä¾§ä¿¡æ¯é¢æ¿ */
      .info-panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: auto;
        overflow-x: hidden;
      }

      .info-section {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .info-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 0;
        border-bottom: 1px solid var(--border-color);
        font-size: 13px;
      }

      .info-label {
        color: var(--text-light);
      }

      .info-value {
        font-weight: 600;
        color: var(--text-color);
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 1200px) {
        body {
          overflow: auto;
          height: auto;
        }

        .main-container {
          height: auto;
          overflow: visible;
        }

        .workspace {
          grid-template-columns: 1fr;
          grid-template-rows: auto;
          overflow: visible;
        }

        .toolbar,
        .info-panel {
          max-height: none;
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 10px;
          padding-bottom: 0; /* ç§»é™¤å›ºå®špadding */
          height: 100vh;
          overflow: hidden; /* é˜²æ­¢bodyæ»šåŠ¨ */
        }

        .main-container {
          height: 100%;
          display: flex;
          flex-direction: column;
          overflow: hidden;
        }

        .header {
          flex-shrink: 0; /* å¤´éƒ¨ä¸æ”¶ç¼© */
        }

        .header h1 {
          font-size: 24px;
        }

        .header p {
          font-size: 13px;
        }

        .workspace {
          flex: 1; /* å æ®å‰©ä½™ç©ºé—´ */
          overflow: hidden;
          position: relative;
        }

        .canvas-area {
          padding: 15px;
          /* ä¸ºå·¥å…·æ é¢„ç•™è¶³å¤Ÿç©ºé—´,é€‚é…å®‰å…¨åŒºåŸŸ */
          padding-bottom: calc(260px + env(safe-area-inset-bottom, 0px));
          padding-bottom: calc(260px + constant(safe-area-inset-bottom, 0px)); /* iOS 11.0-11.2 */
          height: 100%;
          overflow-y: auto;
          overflow-x: hidden;
          -webkit-overflow-scrolling: touch;
          background: transparent; /* ç§»é™¤èƒŒæ™¯,ä½¿ç”¨ä¼ªå…ƒç´ æ§åˆ¶ */
          position: relative;
          z-index: 1; /* ç¡®ä¿åœ¨èƒŒæ™¯ä¹‹ä¸Š */
        }

        /* ä½¿ç”¨ä¼ªå…ƒç´ åˆ›å»ºå—æ§é«˜åº¦çš„èƒŒæ™¯,åœ¨å·¥å…·æ ä¸Šæ–¹ç»“æŸ */
        .workspace::before {
          content: '';
          position: absolute;
          top: 0;
          left: 0;
          right: 0;
          /* å·¥å…·æ é«˜åº¦ + åœ†è§’è¿‡æ¸¡åŒº + å®‰å…¨åŒºåŸŸç¼“å†² */
          bottom: calc(200px + env(safe-area-inset-bottom, 0px) + 50px);
          bottom: calc(200px + constant(safe-area-inset-bottom, 0px) + 50px); /* iOS 11.0-11.2 */
          background: #f8f9fa;
          z-index: 0; /* ç½®äºå†…å®¹ä¸‹æ–¹ */
          pointer-events: none;
        }

        .canvas-wrapper {
          max-height: none; /* å…è®¸è‡ªç„¶é«˜åº¦ */
          position: relative;
        }

        #canvas {
          max-width: 100%;
          width: auto;
          height: auto;
          object-fit: contain;
          margin: 0 auto;
          display: block;
        }

        .canvas-container {
          position: relative;
        }

        /* åº•éƒ¨æ¸å˜æç¤º:æé†’ç”¨æˆ·å¯ä»¥æ»šåŠ¨,ä¸èƒŒæ™¯åŒºåŸŸå¯¹é½ */
        .workspace::after {
          content: '';
          position: absolute;
          /* ä¸èƒŒæ™¯ç»“æŸä½ç½®å¯¹é½,é€‚é…å®‰å…¨åŒºåŸŸ */
          bottom: calc(200px + env(safe-area-inset-bottom, 0px) + 50px);
          bottom: calc(200px + constant(safe-area-inset-bottom, 0px) + 50px); /* iOS 11.0-11.2 */
          left: 0;
          right: 0;
          height: 60px;
          background: linear-gradient(to top, rgba(248, 249, 250, 1), transparent);
          pointer-events: none;
          z-index: 2; /* åœ¨ canvas-area ä¹‹ä¸Š */
          transition: opacity 0.3s ease;
        }

        /* æ»šåŠ¨åˆ°åº•éƒ¨æ—¶éšè—æ¸å˜ */
        .workspace.scrolled-to-bottom::after {
          opacity: 0;
        }

        .upload-area {
          padding: 40px 20px;
        }

        .upload-icon {
          font-size: 48px;
        }

        .upload-text {
          font-size: 16px;
        }

        .toolbar,
        .info-panel {
          display: none;
        }
      }

      /* Toastæç¤º */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.15);
        display: flex;
        align-items: center;
        gap: 12px;
        z-index: 10000;
        transform: translateX(400px);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        max-width: 350px;
      }

      .toast.show {
        transform: translateX(0);
      }

      .toast-icon {
        font-size: 20px;
      }

      .toast-message {
        font-size: 14px;
        color: var(--text-color);
        font-weight: 500;
      }

      .toast.success {
        border-left: 4px solid var(--success-color);
      }

      .toast.error {
        border-left: 4px solid #ef4444;
      }

      .toast.warning {
        border-left: 4px solid var(--accent-color);
      }

      .toast.info {
        border-left: 4px solid var(--info-color);
      }

      /* ç§»åŠ¨ç«¯å·¥å…·æ  */
      .mobile-toolbar {
        display: none;
      }

      @media (max-width: 768px) {
        /* ç§»åŠ¨ç«¯ Toast ä¼˜åŒ– */
        .toast {
          top: auto;
          bottom: calc(220px + env(safe-area-inset-bottom, 0px)); /* åœ¨å·¥å…·æ ä¸Šæ–¹ */
          bottom: calc(220px + constant(safe-area-inset-bottom, 0px));
          left: 50%;
          right: auto;
          transform: translate(-50%, 100px); /* å±…ä¸­å¹¶ä»ä¸‹æ–¹éšè— */
          max-width: 280px; /* å›ºå®šæœ€å¤§å®½åº¦,æ›´ç´§å‡‘ */
          width: auto; /* è‡ªåŠ¨å®½åº¦,æ ¹æ®å†…å®¹ */
          padding: 12px 18px; /* å‡å°å†…è¾¹è· */
          gap: 10px; /* æ›´ç´§å‡‘çš„å›¾æ ‡å’Œæ–‡å­—é—´è· */
          border-radius: 16px; /* æ›´å¤§çš„åœ†è§’ */
          box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2), 0 0 0 1px rgba(0, 0, 0, 0.05);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          background: rgba(255, 255, 255, 0.95);
          opacity: 0; /* åˆå§‹å®Œå…¨é€æ˜ */
          pointer-events: none; /* åˆå§‹ä¸æ¥æ”¶ç‚¹å‡» */
        }

        .toast.show {
          transform: translate(-50%, 0); /* å±…ä¸­å¹¶æ˜¾ç¤º */
          opacity: 1; /* å®Œå…¨ä¸é€æ˜ */
          pointer-events: auto; /* å¯æ¥æ”¶ç‚¹å‡» */
          animation: toastSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); /* å¼¹æ€§åŠ¨ç”» */
        }

        /* Toast æ»‘å…¥åŠ¨ç”» */
        @keyframes toastSlideIn {
          0% {
            transform: translate(-50%, 100px);
            opacity: 0;
          }
          100% {
            transform: translate(-50%, 0);
            opacity: 1;
          }
        }

        /* Toast ç±»å‹æ ·å¼ä¼˜åŒ– */
        .toast.success {
          border-left: none;
          background: linear-gradient(135deg, rgba(42, 157, 143, 0.95) 0%, rgba(42, 157, 143, 0.85) 100%);
          color: white;
        }

        .toast.success .toast-message {
          color: white;
        }

        .toast.error {
          border-left: none;
          background: linear-gradient(135deg, rgba(239, 68, 68, 0.95) 0%, rgba(239, 68, 68, 0.85) 100%);
          color: white;
        }

        .toast.error .toast-message {
          color: white;
        }

        .toast.warning {
          border-left: none;
          background: linear-gradient(135deg, rgba(255, 214, 0, 0.95) 0%, rgba(255, 193, 7, 0.85) 100%);
          color: #333;
        }

        .toast.warning .toast-message {
          color: #333;
        }

        .toast.info {
          border-left: none;
          background: linear-gradient(135deg, rgba(152, 193, 217, 0.95) 0%, rgba(152, 193, 217, 0.85) 100%);
          color: white;
        }

        .toast.info .toast-message {
          color: white;
        }

        .toast-icon {
          font-size: 20px; /* æ›´å°çš„å›¾æ ‡ */
          flex-shrink: 0; /* å›¾æ ‡ä¸æ”¶ç¼© */
        }

        .toast-message {
          font-size: 14px; /* æ›´å°çš„å­—ä½“ */
          font-weight: 500; /* å‡è½»å­—é‡ */
          line-height: 1.4; /* æ›´å¥½çš„è¡Œé«˜ */
        }

        /* Toast è§¦æ‘¸åé¦ˆ */
        .toast:active {
          transform: translate(-50%, 0) scale(0.98);
          transition: transform 0.1s ease;
        }

        /* Toast æ»‘å‡ºåŠ¨ç”» */
        @keyframes toastSlideOut {
          0% {
            transform: translate(-50%, 0);
            opacity: 1;
          }
          100% {
            transform: translate(-50%, 100px);
            opacity: 0;
          }
        }
      }

      /* å°å±å¹•è®¾å¤‡ä¼˜åŒ– */
      @media (max-width: 480px) {
        .toast {
          max-width: 260px; /* æ›´å°çš„æœ€å¤§å®½åº¦ */
          width: auto;
          padding: 10px 16px; /* æ›´ç´§å‡‘çš„å†…è¾¹è· */
        }

        .toast-icon {
          font-size: 18px; /* æ›´å°çš„å›¾æ ‡ */
        }

        .toast-message {
          font-size: 13px; /* æ›´å°çš„å­—ä½“ */
        }
      }

      @media (max-width: 768px) {
        /* ç§»åŠ¨ç«¯å·¥å…·æ å®¹å™¨ - è°ƒæ•´å±‚çº§é¡ºåº */
        .mobile-toolbar-wrapper {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          display: flex;
          flex-direction: column-reverse; /* âœ¨ åè½¬:å¯¼èˆªåœ¨ä¸‹,å†…å®¹åœ¨ä¸Š */
          background: rgba(255, 255, 255, 0.98);
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
          box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
          z-index: 1000;
          border-radius: 20px 20px 0 0; /* âœ¨ é¡¶éƒ¨åœ†è§’ */
          padding-bottom: env(safe-area-inset-bottom); /* âœ¨ iOS å®‰å…¨åŒºåŸŸé€‚é… */
          padding-bottom: constant(safe-area-inset-bottom); /* âœ¨ iOS 11.0-11.2 å…¼å®¹ */
        }

        /* æ ‡ç­¾é¡µå¯¼èˆª - æ¨ªå‘æ»šåŠ¨çš„æ‰å¹³åŒ–å¯¼èˆª */
        .mobile-tabs {
          display: flex;
          border-top: 1px solid #e9ecef;
          background: #fff;
          padding: 0;
          padding-bottom: 8px; /* âœ¨ åº•éƒ¨é¢å¤–é—´è· */
          min-height: 44px;
          overflow-x: auto;
          overflow-y: hidden;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: none; /* Firefox */
        }

        .mobile-tabs::-webkit-scrollbar {
          display: none; /* Chrome/Safari */
        }

        .mobile-tab {
          flex-shrink: 0; /* ä¸æ”¶ç¼© */
          padding: 0 16px;
          background: transparent;
          border: none;
          font-size: 14px;
          font-weight: 500;
          color: #6c757d;
          cursor: pointer;
          transition: all 0.2s ease;
          display: flex;
          align-items: center;
          justify-content: center;
          -webkit-tap-highlight-color: transparent;
          position: relative;
          white-space: nowrap; /* ä¸æ¢è¡Œ */
        }

        /* éšè—å›¾æ ‡,çº¯æ–‡å­—å¯¼èˆª */
        .mobile-tab i {
          display: none;
        }

        .mobile-tab.active {
          color: #ffd600;
          font-weight: 600;
        }

        .mobile-tab.active::after {
          content: '';
          position: absolute;
          bottom: 0;
          left: 8px;
          right: 8px;
          height: 3px;
          background: #ffd600;
          border-radius: 3px 3px 0 0;
        }

        /* æ ‡ç­¾é¡µå†…å®¹åŒº - ç®€åŒ–å¸ƒå±€ */
        .mobile-tab-content {
          display: none;
          padding: 16px 12px 12px 12px; /* å¢åŠ é¡¶éƒ¨å†…è¾¹è· */
          background: #fff;
          border-top: 1px solid #e9ecef;
          min-height: 60px; /* ç¡®ä¿æœ€å°é«˜åº¦,é˜²æ­¢å†…å®¹å¤ªå°‘æ—¶è§†è§‰ä¸å¹³è¡¡ */
        }

        .mobile-tab-content.active {
          display: block;
          animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
          from { opacity: 0; }
          to { opacity: 1; }
        }

        /* é€‰é¡¹è¡Œ - æ¨ªå‘æ»šåŠ¨çš„æ‰å¹³åŒ–æŒ‰é’® */
        .mobile-option-row {
          display: flex;
          gap: 8px;
          overflow-x: auto;
          overflow-y: hidden;
          -webkit-overflow-scrolling: touch;
          scrollbar-width: none; /* Firefox */
          padding-bottom: 2px; /* é˜²æ­¢æŒ‰é’®é˜´å½±è¢«è£å‰ª */
        }

        .mobile-option-row::-webkit-scrollbar {
          display: none; /* Chrome/Safari */
        }

        .mobile-option-btn {
          flex-shrink: 0; /* ä¸æ”¶ç¼©,ä¿æŒæŒ‰é’®å®Œæ•´ */
          min-width: 80px;
          padding: 12px 16px;
          background: #f8f9fa;
          border: 2px solid #e9ecef;
          border-radius: 8px;
          font-size: 14px;
          font-weight: 500;
          color: #495057;
          cursor: pointer;
          transition: all 0.2s ease;
          -webkit-tap-highlight-color: transparent;
          white-space: nowrap; /* æ–‡å­—ä¸æ¢è¡Œ */
        }

        .mobile-option-btn:active {
          transform: scale(0.97);
        }

        .mobile-option-btn.active {
          background: #ffd600;
          border-color: #ffd600;
          color: #333;
          font-weight: 600;
        }

        .mobile-option-btn.mobile-reset-confirm {
          background: #fff3cd;
          border-color: #ffc107;
          color: #856404;
          flex: auto;
        }

        /* æ»‘å—è¡Œ - ç®€åŒ–çš„æ»‘å—å¸ƒå±€ */
        .mobile-slider-row {
          display: flex;
          align-items: center;
          gap: 12px;
          padding: 8px 0;
          width: 100%; /* å æ»¡å®¹å™¨å®½åº¦ */
        }

        .mobile-slider-row input[type="range"] {
          flex: 1;
          height: 8px;
          border-radius: 4px;
          background: #e9ecef;
          outline: none;
          -webkit-appearance: none;
          appearance: none;
        }

        .mobile-slider-row input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 24px;
          height: 24px;
          border-radius: 50%;
          background: #ffd600;
          cursor: pointer;
          box-shadow: 0 2px 8px rgba(255, 214, 0, 0.5);
          border: 3px solid #fff;
        }

        .mobile-slider-row input[type="range"]::-moz-range-thumb {
          width: 24px;
          height: 24px;
          border-radius: 50%;
          background: #ffd600;
          cursor: pointer;
          border: 3px solid #fff;
          box-shadow: 0 2px 8px rgba(255, 214, 0, 0.5);
        }

        .mobile-slider-row .mobile-slider-value {
          flex-shrink: 0;
          min-width: 54px;
          text-align: right;
          font-weight: 700;
          color: #495057;
          font-size: 16px;
          font-variant-numeric: tabular-nums;
        }

        /* åŸºç¡€å·¥å…·æ  */
        .mobile-toolbar {
          display: grid;
          grid-template-columns: repeat(4, 1fr);
          gap: 6px;
        }

        .mobile-toolbar .tool-btn {
          padding: 8px 6px;
          font-size: 11px;
          flex-direction: column;
          gap: 4px;
          min-height: 52px;
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 8px;
          color: #495057;
        }

        .mobile-toolbar .tool-btn:active {
          background: #e9ecef;
          transform: scale(0.98);
        }

        .mobile-toolbar .tool-btn span:first-child {
          font-size: 18px;
        }

        /* æ»¤é•œç½‘æ ¼ */
        .mobile-filter-grid {
          display: grid;
          grid-template-columns: repeat(3, 1fr);
          gap: 6px;
        }

        .mobile-filter-grid .filter-btn {
          padding: 8px 6px;
          font-size: 11px;
          text-align: center;
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 8px;
          cursor: pointer;
          transition: all 0.2s ease;
          display: flex;
          flex-direction: column;
          align-items: center;
          gap: 4px;
          min-height: 52px;
          color: #495057;
        }

        .mobile-filter-grid .filter-btn::before {
          font-family: "Font Awesome 6 Free";
          font-weight: 900;
          font-size: 16px;
          color: #6c757d;
        }

        .mobile-filter-grid .filter-btn[data-filter="none"]::before {
          content: "\f03e"; /* image */
        }

        .mobile-filter-grid .filter-btn[data-filter="grayscale"]::before {
          content: "\f53f"; /* moon */
        }

        .mobile-filter-grid .filter-btn[data-filter="sepia"]::before {
          content: "\f70c"; /* history */
        }

        .mobile-filter-grid .filter-btn[data-filter="invert"]::before {
          content: "\f362"; /* adjust */
        }

        .mobile-filter-grid .filter-btn[data-filter="blur"]::before {
          content: "\f111"; /* circle */
        }

        .mobile-filter-grid .filter-btn[data-filter="saturate"]::before {
          content: "\f5c3"; /* palette */
        }

        .mobile-filter-grid .filter-btn.active {
          background: #ffd600;
          color: #333;
          border-color: #ffd600;
          font-weight: 600;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .mobile-filter-grid .filter-btn.active::before {
          color: #333;
        }

        .mobile-filter-grid .filter-btn:active {
          transform: scale(0.98);
        }

        /* è°ƒæ•´æ»‘å— - ä¼˜åŒ–å•è¡Œå¸ƒå±€ */
        .mobile-slider-control {
          margin-bottom: 14px;
          display: flex;
          align-items: center;
          gap: 10px;
          background: #fff;
          padding: 12px;
          border-radius: 8px;
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .mobile-slider-control:last-child {
          margin-bottom: 0;
        }

        .mobile-slider-label {
          flex-shrink: 0;
          min-width: 56px;
          font-size: 13px;
          color: #495057;
          font-weight: 600;
          display: flex;
          align-items: center;
          gap: 6px;
        }

        .mobile-slider-label::before {
          font-family: "Font Awesome 6 Free";
          font-weight: 900;
          font-size: 14px;
          color: #ffd600;
        }

        .mobile-slider-label[data-slider="brightness"]::before {
          content: "\f185"; /* sun */
        }

        .mobile-slider-label[data-slider="contrast"]::before {
          content: "\f042"; /* adjust */
        }

        .mobile-slider-label[data-slider="saturation"]::before {
          content: "\f043"; /* tint */
        }

        .mobile-slider-control input[type="range"] {
          flex: 1;
          height: 6px;
          border-radius: 3px;
          background: #e9ecef;
          outline: none;
          -webkit-appearance: none;
          appearance: none;
        }

        .mobile-slider-control input[type="range"]::-webkit-slider-thumb {
          -webkit-appearance: none;
          appearance: none;
          width: 20px;
          height: 20px;
          border-radius: 50%;
          background: #ffd600;
          cursor: pointer;
          box-shadow: 0 2px 6px rgba(255, 214, 0, 0.4);
          border: 2px solid #fff;
        }

        .mobile-slider-control input[type="range"]::-moz-range-thumb {
          width: 20px;
          height: 20px;
          border-radius: 50%;
          background: #ffd600;
          cursor: pointer;
          border: 2px solid #fff;
          box-shadow: 0 2px 6px rgba(255, 214, 0, 0.4);
        }

        .mobile-slider-value {
          flex-shrink: 0;
          min-width: 48px;
          text-align: right;
          font-weight: 700;
          color: #495057;
          font-size: 13px;
          font-variant-numeric: tabular-nums; /* ç­‰å®½æ•°å­— */
        }

        /* å¯¼å‡ºæŒ‰é’®ç½‘æ ¼ */
        .mobile-export-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 8px;
        }

        .mobile-export-grid .tool-btn {
          padding: 12px 8px;
          font-size: 12px;
          font-weight: 600;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
          min-height: 52px;
          background: #f8f9fa;
          border: 1px solid #e9ecef;
          border-radius: 8px;
          color: #495057;
        }

        .mobile-export-grid .tool-btn:active {
          background: #e9ecef;
          transform: scale(0.98);
        }

        .mobile-export-grid .tool-btn i {
          font-size: 16px;
        }

        /* ç§»åŠ¨ç«¯è£å‰ªå·¥å…·æ  */
        .mobile-crop-toolbar {
          position: fixed;
          bottom: 0;
          left: 0;
          right: 0;
          background: rgba(255, 255, 255, 0.95);
          padding: 12px;
          padding-bottom: calc(12px + env(safe-area-inset-bottom, 0px)); /* âœ¨ iOS å®‰å…¨åŒºåŸŸé€‚é… */
          padding-bottom: calc(12px + constant(safe-area-inset-bottom, 0px)); /* âœ¨ iOS 11.0-11.2 */
          border-radius: 20px 20px 0 0; /* âœ¨ ç»Ÿä¸€åœ†è§’å¤§å° */
          box-shadow: 0 -4px 16px rgba(0, 0, 0, 0.15);
          z-index: 1001;
          backdrop-filter: blur(20px);
          -webkit-backdrop-filter: blur(20px);
        }

        .crop-ratio-selector {
          display: flex;
          gap: 6px;
          margin-bottom: 10px;
          overflow-x: auto;
          padding-bottom: 4px;
          -webkit-overflow-scrolling: touch;
        }

        .crop-ratio-selector::-webkit-scrollbar {
          height: 3px;
        }

        .crop-ratio-selector::-webkit-scrollbar-thumb {
          background: rgba(139, 92, 246, 0.3);
          border-radius: 2px;
        }

        .ratio-mini-btn {
          flex-shrink: 0;
          padding: 8px 16px;
          background: rgba(139, 92, 246, 0.1);
          border: 1.5px solid rgba(139, 92, 246, 0.3);
          border-radius: 8px;
          font-size: 13px;
          font-weight: 600;
          color: var(--text-color);
          cursor: pointer;
          transition: all 0.2s ease;
          white-space: nowrap;
        }

        .ratio-mini-btn.active {
          background: var(--primary-color);
          color: white;
          border-color: var(--primary-color);
        }

        .crop-actions {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 8px;
        }

        .crop-actions .tool-btn {
          padding: 12px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 6px;
          flex-direction: row;
        }

        .crop-actions .tool-btn span:first-child {
          font-size: 18px;
        }

        .crop-actions .tool-btn span:last-child {
          font-size: 14px;
          font-weight: 600;
        }

        .crop-actions .tool-btn.secondary {
          background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);
        }

        .crop-actions .tool-btn.primary {
          background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 100%);
        }
      }

      /* ç§»åŠ¨ç«¯æŠ½å±‰é¢æ¿ */
      .mobile-drawer {
        display: none;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        background: white;
        border-radius: 20px 20px 0 0;
        box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.15);
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 10001;
        max-height: 70vh;
        overflow-y: auto;
      }

      .mobile-drawer.active {
        transform: translateY(0);
      }

      .drawer-handle {
        padding: 12px;
        text-align: center;
        cursor: pointer;
      }

      .drawer-handle-bar {
        width: 40px;
        height: 4px;
        background: var(--border-color);
        border-radius: 2px;
        margin: 0 auto;
      }

      .drawer-content {
        padding: 0 15px 20px;
      }

      .drawer-section {
        margin-bottom: 20px;
      }

      .drawer-section-title {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-color);
        margin-bottom: 10px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      .drawer-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
      }

      .drawer-overlay.active {
        display: block;
      }

      @media (max-width: 768px) {
        .mobile-drawer {
          display: block;
        }
      }
    </style>
  </head>
  <body>
    <!-- Toastæç¤º -->
    <div class="toast" id="toast">
      <span class="toast-icon" id="toastIcon">âœ…</span>
      <span class="toast-message" id="toastMessage">æ“ä½œæˆåŠŸ</span>
    </div>

    <!-- è¿”å›é¦–é¡µæŒ‰é’® -->
    <a href="../../index.html" class="back-home-btn">è¿”å›é¦–é¡µ</a>

    <div class="main-container">
      <!-- å¤´éƒ¨ -->
      <div class="header">
        <h1>âœ‚ï¸ å›¾ç‰‡è£å‰ªå·¥å…·</h1>
        <p>åœ¨çº¿å›¾ç‰‡ç¼–è¾‘å™¨ - æ”¯æŒè£å‰ªã€æ—‹è½¬ã€æ»¤é•œç­‰å¤šç§åŠŸèƒ½</p>
      </div>

      <!-- å·¥ä½œåŒº -->
      <div class="workspace">
        <!-- å·¦ä¾§å·¥å…·æ  -->
        <div class="toolbar">
          <div class="tool-section">
            <div class="tool-section-title">ğŸ“¤ å›¾ç‰‡æ“ä½œ</div>
            <button class="tool-btn" id="uploadBtn">
              <span>ğŸ“</span>
              <span>é€‰æ‹©å›¾ç‰‡</span>
            </button>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
              <button class="tool-btn secondary" id="undoBtn" disabled>
                <span>â†¶</span>
                <span>æ’¤é”€</span>
              </button>
              <button class="tool-btn secondary" id="redoBtn" disabled>
                <span>â†·</span>
                <span>é‡åš</span>
              </button>
            </div>
            <button class="tool-btn secondary" id="resetBtn" disabled>
              <span>ğŸ”„</span>
              <span>é‡ç½®</span>
            </button>
          </div>

          <div class="tool-section">
            <div class="tool-section-title">âœ‚ï¸ è£å‰ªæ¯”ä¾‹</div>
            <div class="ratio-grid">
              <div class="ratio-btn active" data-ratio="free">è‡ªç”±</div>
              <div class="ratio-btn" data-ratio="1:1">1:1</div>
              <div class="ratio-btn" data-ratio="4:3">4:3</div>
              <div class="ratio-btn" data-ratio="16:9">16:9</div>
              <div class="ratio-btn" data-ratio="3:4">3:4</div>
              <div class="ratio-btn" data-ratio="9:16">9:16</div>
            </div>
            <button class="tool-btn" id="applyCropBtn" disabled>
              <span>âœ‚ï¸</span>
              <span>åº”ç”¨è£å‰ª</span>
            </button>
          </div>

          <div class="tool-section">
            <div class="tool-section-title">ğŸ”„ æ—‹è½¬ç¿»è½¬</div>
            <button class="tool-btn" id="rotateLeftBtn" disabled>
              <span>â†¶</span>
              <span>å·¦æ—‹90Â°</span>
            </button>
            <button class="tool-btn" id="rotateRightBtn" disabled>
              <span>â†·</span>
              <span>å³æ—‹90Â°</span>
            </button>
            <button class="tool-btn" id="flipHBtn" disabled>
              <span>â†”ï¸</span>
              <span>æ°´å¹³ç¿»è½¬</span>
            </button>
            <button class="tool-btn" id="flipVBtn" disabled>
              <span>â†•ï¸</span>
              <span>å‚ç›´ç¿»è½¬</span>
            </button>
          </div>

          <div class="tool-section">
            <div class="tool-section-title">ğŸ¨ æ»¤é•œæ•ˆæœ</div>
            <div class="filter-grid">
              <div class="filter-btn active" data-filter="none">åŸå›¾</div>
              <div class="filter-btn" data-filter="grayscale">é»‘ç™½</div>
              <div class="filter-btn" data-filter="sepia">å¤å¤</div>
              <div class="filter-btn" data-filter="invert">åè‰²</div>
              <div class="filter-btn" data-filter="blur">æ¨¡ç³Š</div>
              <div class="filter-btn" data-filter="saturate">é²œè‰³</div>
            </div>
          </div>

          <div class="tool-section">
            <div class="tool-section-title">âš¡ å›¾ç‰‡è°ƒæ•´</div>
            <div class="slider-control">
              <div class="slider-label">
                <span>äº®åº¦</span>
                <span class="slider-value" id="brightnessValue">100%</span>
              </div>
              <input type="range" id="brightnessSlider" min="0" max="200" value="100" disabled />
            </div>
            <div class="slider-control">
              <div class="slider-label">
                <span>å¯¹æ¯”åº¦</span>
                <span class="slider-value" id="contrastValue">100%</span>
              </div>
              <input type="range" id="contrastSlider" min="0" max="200" value="100" disabled />
            </div>
            <div class="slider-control">
              <div class="slider-label">
                <span>é¥±å’Œåº¦</span>
                <span class="slider-value" id="saturationValue">100%</span>
              </div>
              <input type="range" id="saturationSlider" min="0" max="200" value="100" disabled />
            </div>
          </div>

          <div class="tool-section">
            <div class="tool-section-title">ğŸ’¾ å¯¼å‡ºå›¾ç‰‡</div>
            <button class="tool-btn" id="downloadPNGBtn" disabled>
              <span>â¬‡ï¸</span>
              <span>ä¸‹è½½PNG</span>
            </button>
            <button class="tool-btn" id="downloadJPGBtn" disabled>
              <span>â¬‡ï¸</span>
              <span>ä¸‹è½½JPG</span>
            </button>
          </div>
        </div>

        <!-- ä¸­é—´ç”»å¸ƒåŒºåŸŸ -->
        <div class="canvas-area">
          <!-- ä¸Šä¼ åŒºåŸŸ -->
          <div class="upload-area" id="uploadArea">
            <div class="upload-icon">ğŸ“·</div>
            <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</div>
            <div class="upload-hint">æ”¯æŒ JPGã€PNGã€GIF æ ¼å¼ï¼Œæœ€å¤§ 10MB</div>
          </div>
          <input type="file" id="fileInput" accept="image/*" />

          <!-- Canvaså®¹å™¨ -->
          <div class="canvas-container" id="canvasContainer">
            <div class="canvas-wrapper" id="canvasWrapper">
              <canvas id="canvas"></canvas>
              <div class="crop-box" id="cropBox">
                <div class="crop-handle nw"></div>
                <div class="crop-handle ne"></div>
                <div class="crop-handle sw"></div>
                <div class="crop-handle se"></div>
                <div class="crop-handle n"></div>
                <div class="crop-handle s"></div>
                <div class="crop-handle w"></div>
                <div class="crop-handle e"></div>
              </div>
            </div>
          </div>

          <!-- ç§»åŠ¨ç«¯å·¥å…·æ  - æ‰å¹³åŒ–ä¸€çº§åˆ†ç±» -->
          <div class="mobile-toolbar-wrapper" id="mobileToolbarWrapper">
            <!-- ä¸€çº§åˆ†ç±»å¯¼èˆª - å¯æ¨ªå‘æ»šåŠ¨ -->
            <div class="mobile-tabs">
              <button class="mobile-tab active" data-tab="rotate">æ—‹è½¬</button>
              <button class="mobile-tab" data-tab="flip">ç¿»è½¬</button>
              <button class="mobile-tab" data-tab="crop">è£å‰ª</button>
              <button class="mobile-tab" data-tab="filter">æ»¤é•œ</button>
              <button class="mobile-tab" data-tab="brightness">äº®åº¦</button>
              <button class="mobile-tab" data-tab="contrast">å¯¹æ¯”åº¦</button>
              <button class="mobile-tab" data-tab="saturation">é¥±å’Œåº¦</button>
              <button class="mobile-tab" data-tab="history">è¿˜åŸ</button>
              <button class="mobile-tab" data-tab="export">å¯¼å‡º</button>
            </div>

            <!-- æ—‹è½¬ -->
            <div class="mobile-tab-content active" id="tabRotate">
              <div class="mobile-option-row">
                <button class="mobile-option-btn" id="mobileRotateLeftBtn" disabled>å·¦æ—‹ 90Â°</button>
                <button class="mobile-option-btn" id="mobileRotateRightBtn" disabled>å³æ—‹ 90Â°</button>
              </div>
            </div>

            <!-- ç¿»è½¬ -->
            <div class="mobile-tab-content" id="tabFlip">
              <div class="mobile-option-row">
                <button class="mobile-option-btn" id="mobileFlipHBtn" disabled>æ°´å¹³ç¿»è½¬</button>
                <button class="mobile-option-btn" id="mobileFlipVBtn" disabled>å‚ç›´ç¿»è½¬</button>
              </div>
            </div>

            <!-- è£å‰ª -->
            <div class="mobile-tab-content" id="tabCrop">
              <div class="mobile-option-row">
                <button class="mobile-option-btn ratio-btn-mobile active" data-ratio-mobile="free">è‡ªç”±</button>
                <button class="mobile-option-btn ratio-btn-mobile" data-ratio-mobile="1:1">1:1</button>
                <button class="mobile-option-btn ratio-btn-mobile" data-ratio-mobile="4:3">4:3</button>
                <button class="mobile-option-btn ratio-btn-mobile" data-ratio-mobile="16:9">16:9</button>
              </div>
            </div>

            <!-- æ»¤é•œ -->
            <div class="mobile-tab-content" id="tabFilter">
              <div class="mobile-option-row">
                <button class="mobile-option-btn filter-btn-mobile active" data-filter-mobile="none">åŸå›¾</button>
                <button class="mobile-option-btn filter-btn-mobile" data-filter-mobile="grayscale">é»‘ç™½</button>
                <button class="mobile-option-btn filter-btn-mobile" data-filter-mobile="sepia">å¤å¤</button>
                <button class="mobile-option-btn filter-btn-mobile" data-filter-mobile="invert">åè‰²</button>
                <button class="mobile-option-btn filter-btn-mobile" data-filter-mobile="blur">æ¨¡ç³Š</button>
                <button class="mobile-option-btn filter-btn-mobile" data-filter-mobile="saturate">é²œè‰³</button>
              </div>
            </div>

            <!-- äº®åº¦ -->
            <div class="mobile-tab-content" id="tabBrightness">
              <div class="mobile-slider-row">
                <input type="range" id="mobileBrightnessSlider3" min="0" max="200" value="100" disabled />
                <span class="mobile-slider-value" id="mobileBrightnessValue3">100%</span>
              </div>
            </div>

            <!-- å¯¹æ¯”åº¦ -->
            <div class="mobile-tab-content" id="tabContrast">
              <div class="mobile-slider-row">
                <input type="range" id="mobileContrastSlider3" min="0" max="200" value="100" disabled />
                <span class="mobile-slider-value" id="mobileContrastValue3">100%</span>
              </div>
            </div>

            <!-- é¥±å’Œåº¦ -->
            <div class="mobile-tab-content" id="tabSaturation">
              <div class="mobile-slider-row">
                <input type="range" id="mobileSaturationSlider3" min="0" max="200" value="100" disabled />
                <span class="mobile-slider-value" id="mobileSaturationValue3">100%</span>
              </div>
            </div>

            <!-- å†å² -->
            <div class="mobile-tab-content" id="tabHistory">
              <div class="mobile-option-row">
                <button class="mobile-option-btn" id="mobileUndoBtn" disabled>â†¶ æ’¤å›</button>
                <button class="mobile-option-btn" id="mobileRedoBtn" disabled>â†· é‡åš</button>
                <button class="mobile-option-btn mobile-reset-confirm" id="mobileResetBtn2" disabled>âŸ² é‡ç½®å…¨éƒ¨</button>
              </div>
            </div>

            <!-- å¯¼å‡º -->
            <div class="mobile-tab-content" id="tabExport">
              <div class="mobile-option-row">
                <button class="mobile-option-btn" id="mobileDownloadPNGBtn3" disabled>ä¸‹è½½ PNG</button>
                <button class="mobile-option-btn" id="mobileDownloadJPGBtn3" disabled>ä¸‹è½½ JPG</button>
              </div>
            </div>
          </div>

          <!-- ç§»åŠ¨ç«¯è£å‰ªå·¥å…·æ  - è¿›å…¥è£å‰ªæ¨¡å¼æ—¶æ˜¾ç¤º -->
          <div class="mobile-crop-toolbar" id="mobileCropToolbar" style="display: none;">
            <div class="crop-ratio-selector">
              <button class="ratio-mini-btn active" data-ratio-mobile="free">è‡ªç”±</button>
              <button class="ratio-mini-btn" data-ratio-mobile="1:1">1:1</button>
              <button class="ratio-mini-btn" data-ratio-mobile="4:3">4:3</button>
              <button class="ratio-mini-btn" data-ratio-mobile="16:9">16:9</button>
            </div>
            <div class="crop-actions">
              <button class="tool-btn secondary" id="mobileCancelCropBtn">
                <span>âœ•</span>
                <span>å–æ¶ˆ</span>
              </button>
              <button class="tool-btn primary" id="mobileApplyCropBtn2" disabled>
                <span>âœ“</span>
                <span>åº”ç”¨</span>
              </button>
            </div>
          </div>
        </div>

        <!-- å³ä¾§ä¿¡æ¯é¢æ¿ -->
        <div class="info-panel">
          <div class="info-section">
            <div class="tool-section-title">ğŸ“Š å›¾ç‰‡ä¿¡æ¯</div>
            <div class="info-item">
              <span class="info-label">åŸå§‹å°ºå¯¸</span>
              <span class="info-value" id="originalSize">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">å½“å‰å°ºå¯¸</span>
              <span class="info-value" id="currentSize">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">æ–‡ä»¶å¤§å°</span>
              <span class="info-value" id="fileSize">-</span>
            </div>
            <div class="info-item">
              <span class="info-label">æ ¼å¼</span>
              <span class="info-value" id="fileFormat">-</span>
            </div>
          </div>

          <div class="info-section">
            <div class="tool-section-title">ğŸ’¡ ä½¿ç”¨æç¤º</div>
            <p style="font-size: 13px; color: var(--text-light); line-height: 1.6;">
              â€¢ æ‹–æ‹½è£å‰ªæ¡†è¾¹ç¼˜å¯è°ƒæ•´å¤§å°<br/>
              â€¢ ç‚¹å‡»è£å‰ªæ¡†å†…éƒ¨å¯ç§»åŠ¨ä½ç½®<br/>
              â€¢ ä¹å®«æ ¼çº¿è¾…åŠ©æ„å›¾(ä¸‰åˆ†æ³•åˆ™)<br/>
              â€¢ é€‰æ‹©è£å‰ªæ¯”ä¾‹åè‡ªåŠ¨é”å®š<br/>
              â€¢ æ‰€æœ‰æ“ä½œå¯å®æ—¶é¢„è§ˆ<br/>
              â€¢ æ”¯æŒæ’¤é”€å’Œé‡ç½®æ“ä½œ
            </p>
          </div>
        </div>
      </div>
    </div>

    <!-- ç§»åŠ¨ç«¯æŠ½å±‰é®ç½© - å·²åºŸå¼ƒ,ä½¿ç”¨æ‰å¹³åŒ–å¯¼èˆª -->
    <div class="drawer-overlay" id="drawerOverlay" style="display: none;"></div>

    <!-- ç§»åŠ¨ç«¯æŠ½å±‰é¢æ¿ - å·²åºŸå¼ƒ,ä½¿ç”¨æ‰å¹³åŒ–å¯¼èˆª -->
    <div class="mobile-drawer" id="mobileDrawer" style="display: none;">
      <div class="drawer-handle" id="drawerHandle">
        <div class="drawer-handle-bar"></div>
      </div>
      <div class="drawer-content">
        <!-- è£å‰ªåŠŸèƒ½ -->
        <div class="drawer-section">
          <div class="drawer-section-title">âœ‚ï¸ è£å‰ªæ¯”ä¾‹</div>
          <div class="ratio-grid">
            <div class="ratio-btn active" data-ratio="free" data-mobile="true">è‡ªç”±</div>
            <div class="ratio-btn" data-ratio="1:1" data-mobile="true">1:1</div>
            <div class="ratio-btn" data-ratio="4:3" data-mobile="true">4:3</div>
            <div class="ratio-btn" data-ratio="16:9" data-mobile="true">16:9</div>
            <div class="ratio-btn" data-ratio="3:4" data-mobile="true">3:4</div>
            <div class="ratio-btn" data-ratio="9:16" data-mobile="true">9:16</div>
          </div>
          <button class="tool-btn" id="mobileApplyCropBtn" disabled style="margin-top: 10px; width: 100%;">
            <span>âœ‚ï¸</span>
            <span>åº”ç”¨è£å‰ª</span>
          </button>
        </div>

        <!-- æ»¤é•œæ•ˆæœ -->
        <div class="drawer-section">
          <div class="drawer-section-title">ğŸ¨ æ»¤é•œæ•ˆæœ</div>
          <div class="filter-grid">
            <div class="filter-btn active" data-filter="none" data-mobile="true">åŸå›¾</div>
            <div class="filter-btn" data-filter="grayscale" data-mobile="true">é»‘ç™½</div>
            <div class="filter-btn" data-filter="sepia" data-mobile="true">å¤å¤</div>
            <div class="filter-btn" data-filter="invert" data-mobile="true">åè‰²</div>
            <div class="filter-btn" data-filter="blur" data-mobile="true">æ¨¡ç³Š</div>
            <div class="filter-btn" data-filter="saturate" data-mobile="true">é²œè‰³</div>
          </div>
        </div>

        <!-- å›¾ç‰‡è°ƒæ•´ -->
        <div class="drawer-section">
          <div class="drawer-section-title">âš¡ å›¾ç‰‡è°ƒæ•´</div>
          <div class="slider-control">
            <div class="slider-label">
              <span>äº®åº¦</span>
              <span class="slider-value" id="mobileBrightnessValue">100%</span>
            </div>
            <input type="range" id="mobileBrightnessSlider" min="0" max="200" value="100" disabled />
          </div>
          <div class="slider-control">
            <div class="slider-label">
              <span>å¯¹æ¯”åº¦</span>
              <span class="slider-value" id="mobileContrastValue">100%</span>
            </div>
            <input type="range" id="mobileContrastSlider" min="0" max="200" value="100" disabled />
          </div>
          <div class="slider-control">
            <div class="slider-label">
              <span>é¥±å’Œåº¦</span>
              <span class="slider-value" id="mobileSaturationValue">100%</span>
            </div>
            <input type="range" id="mobileSaturationSlider" min="0" max="200" value="100" disabled />
          </div>
        </div>

        <!-- æ—‹è½¬ç¿»è½¬ -->
        <div class="drawer-section">
          <div class="drawer-section-title">ğŸ”„ æ—‹è½¬ç¿»è½¬</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button class="tool-btn" id="mobileRotateLeftBtn" disabled>
              <span>â†¶</span>
              <span>å·¦æ—‹90Â°</span>
            </button>
            <button class="tool-btn" id="mobileRotateRightBtn" disabled>
              <span>â†·</span>
              <span>å³æ—‹90Â°</span>
            </button>
            <button class="tool-btn" id="mobileFlipHBtn" disabled>
              <span>â†”ï¸</span>
              <span>æ°´å¹³ç¿»è½¬</span>
            </button>
            <button class="tool-btn" id="mobileFlipVBtn" disabled>
              <span>â†•ï¸</span>
              <span>å‚ç›´ç¿»è½¬</span>
            </button>
          </div>
        </div>

        <!-- å¯¼å‡ºä¸‹è½½ -->
        <div class="drawer-section">
          <div class="drawer-section-title">ğŸ’¾ å¯¼å‡ºå›¾ç‰‡</div>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px;">
            <button class="tool-btn" id="mobileDownloadPNGBtn" disabled>
              <span>â¬‡ï¸</span>
              <span>ä¸‹è½½PNG</span>
            </button>
            <button class="tool-btn" id="mobileDownloadJPGBtn" disabled>
              <span>â¬‡ï¸</span>
              <span>ä¸‹è½½JPG</span>
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="../../shared/scripts/common.js"></script>
    <script src="../../shared/scripts/theme.js"></script>
    <script>
      // å…¨å±€å˜é‡
      let originalImage = null;
      let canvas = document.getElementById('canvas');
      let ctx = canvas.getContext('2d');
      let currentImage = null;
      let cropRatio = null;
      let isDragging = false;
      let isResizing = false;
      let dragStart = { x: 0, y: 0 };
      let resizeHandle = null;

      // å›¾ç‰‡çŠ¶æ€
      let imageState = {
        brightness: 100,
        contrast: 100,
        saturation: 100,
        filter: 'none',
        rotation: 0,
        flipH: false,
        flipV: false
      };

      // å†å²è®°å½•ç³»ç»Ÿ
      let history = [];
      let historyIndex = -1;
      const MAX_HISTORY = 20;

      // DOMå…ƒç´ 
      const uploadArea = document.getElementById('uploadArea');
      const fileInput = document.getElementById('fileInput');
      const canvasContainer = document.getElementById('canvasContainer');
      const cropBox = document.getElementById('cropBox');

      // åˆå§‹åŒ–
      function init() {
        bindEvents();
      }

      // ç»‘å®šäº‹ä»¶
      function bindEvents() {
        // ä¸Šä¼ ç›¸å…³
        uploadArea.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', handleFileSelect);
        uploadArea.addEventListener('dragover', handleDragOver);
        uploadArea.addEventListener('dragleave', handleDragLeave);
        uploadArea.addEventListener('drop', handleDrop);

        document.getElementById('uploadBtn').addEventListener('click', () => fileInput.click());

        // è£å‰ªæ¯”ä¾‹ (ä»…ç»‘å®šPCç«¯æŒ‰é’®)
        document.querySelectorAll('.toolbar .ratio-btn').forEach(btn => {
          btn.addEventListener('click', handleRatioChange);
        });

        // æ—‹è½¬ç¿»è½¬
        document.getElementById('rotateLeftBtn').addEventListener('click', () => rotateImage(-90));
        document.getElementById('rotateRightBtn').addEventListener('click', () => rotateImage(90));
        document.getElementById('flipHBtn').addEventListener('click', flipHorizontal);
        document.getElementById('flipVBtn').addEventListener('click', flipVertical);

        // æ»¤é•œ (ä»…ç»‘å®šPCç«¯æŒ‰é’®)
        document.querySelectorAll('.toolbar .filter-btn').forEach(btn => {
          btn.addEventListener('click', handleFilterChange);
        });

        // æ»‘å—
        document.getElementById('brightnessSlider').addEventListener('input', handleBrightnessChange);
        document.getElementById('contrastSlider').addEventListener('input', handleContrastChange);
        document.getElementById('saturationSlider').addEventListener('input', handleSaturationChange);

        // å¯¼å‡º
        document.getElementById('downloadPNGBtn').addEventListener('click', () => downloadImage('png'));
        document.getElementById('downloadJPGBtn').addEventListener('click', () => downloadImage('jpeg'));

        // é‡ç½®
        document.getElementById('resetBtn').addEventListener('click', resetImage);

        // æ’¤é”€/é‡åš
        document.getElementById('undoBtn').addEventListener('click', undo);
        document.getElementById('redoBtn').addEventListener('click', redo);

        // åº”ç”¨è£å‰ª
        document.getElementById('applyCropBtn').addEventListener('click', applyCrop);

        // ç§»åŠ¨ç«¯æ‰å¹³åŒ–å¯¼èˆªæŒ‰é’®
        document.getElementById('mobileRotateLeftBtn').addEventListener('click', () => rotateImage(-90));
        document.getElementById('mobileRotateRightBtn').addEventListener('click', () => rotateImage(90));
        document.getElementById('mobileFlipHBtn').addEventListener('click', flipHorizontal);
        document.getElementById('mobileFlipVBtn').addEventListener('click', flipVertical);
        document.getElementById('mobileUndoBtn').addEventListener('click', undo);
        document.getElementById('mobileRedoBtn').addEventListener('click', redo);
        document.getElementById('mobileResetBtn2').addEventListener('click', resetImage);
        document.getElementById('mobileDownloadPNGBtn3').addEventListener('click', () => downloadImage('png'));
        document.getElementById('mobileDownloadJPGBtn3').addEventListener('click', () => downloadImage('jpeg'));

        // ç§»åŠ¨ç«¯æ—§ç‰ˆæœ¬æ»‘å— (slider1 ç³»åˆ— - å¦‚æœå­˜åœ¨)
        const mobileBrightnessSlider = document.getElementById('mobileBrightnessSlider');
        if (mobileBrightnessSlider) {
          mobileBrightnessSlider.addEventListener('input', (e) => {
            imageState.brightness = parseInt(e.target.value);
            document.getElementById('mobileBrightnessValue').textContent = imageState.brightness + '%';
            // åŒæ­¥PCç«¯
            document.getElementById('brightnessSlider').value = imageState.brightness;
            document.getElementById('brightnessValue').textContent = imageState.brightness + '%';
            renderImage();
          });
        }

        const mobileContrastSlider = document.getElementById('mobileContrastSlider');
        if (mobileContrastSlider) {
          mobileContrastSlider.addEventListener('input', (e) => {
            imageState.contrast = parseInt(e.target.value);
            document.getElementById('mobileContrastValue').textContent = imageState.contrast + '%';
            // åŒæ­¥PCç«¯
            document.getElementById('contrastSlider').value = imageState.contrast;
            document.getElementById('contrastValue').textContent = imageState.contrast + '%';
            renderImage();
          });
        }

        const mobileSaturationSlider = document.getElementById('mobileSaturationSlider');
        if (mobileSaturationSlider) {
          mobileSaturationSlider.addEventListener('input', (e) => {
            imageState.saturation = parseInt(e.target.value);
            document.getElementById('mobileSaturationValue').textContent = imageState.saturation + '%';
            // åŒæ­¥PCç«¯
            document.getElementById('saturationSlider').value = imageState.saturation;
            document.getElementById('saturationValue').textContent = imageState.saturation + '%';
            renderImage();
          });
        }

        // ç§»åŠ¨ç«¯æ»¤é•œæŒ‰é’® (ä½¿ç”¨äº‹ä»¶å§”æ‰˜)
        document.querySelectorAll('.filter-btn[data-mobile="true"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            // åŒæ­¥ç§»åŠ¨ç«¯å’ŒPCç«¯çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            const filter = e.currentTarget.dataset.filter;
            document.querySelectorAll(`.filter-btn[data-filter="${filter}"]`).forEach(b => b.classList.add('active'));
            imageState.filter = filter;
            renderImage();
          });
        });

        // ç§»åŠ¨ç«¯è£å‰ªæ¯”ä¾‹æŒ‰é’®
        document.querySelectorAll('.ratio-btn[data-mobile="true"]').forEach(btn => {
          btn.addEventListener('click', (e) => {
            // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½å›¾ç‰‡
            if (!currentImage) {
              showToast('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'warning');
              return;
            }

            // åŒæ­¥ç§»åŠ¨ç«¯å’ŒPCç«¯çš„æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.ratio-btn').forEach(b => b.classList.remove('active'));
            const ratio = e.currentTarget.dataset.ratio;
            document.querySelectorAll(`.ratio-btn[data-ratio="${ratio}"]`).forEach(b => b.classList.add('active'));

            if (ratio === 'free') {
              cropRatio = null;
            } else {
              const [w, h] = ratio.split(':').map(Number);
              cropRatio = w / h;
            }

            // åˆå§‹åŒ–æˆ–æ›´æ–°è£å‰ªæ¡†
            initCropBox();
          });
        });

        // ç§»åŠ¨ç«¯è£å‰ªå·¥å…·æ æŒ‰é’®
        document.querySelectorAll('.ratio-mini-btn').forEach(btn => {
          btn.addEventListener('click', (e) => {
            if (!currentImage) return;

            // æ›´æ–°æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.ratio-mini-btn').forEach(b => b.classList.remove('active'));
            e.target.classList.add('active');

            // è®¾ç½®è£å‰ªæ¯”ä¾‹
            const ratio = e.target.dataset.ratioMobile;
            if (ratio === 'free') {
              cropRatio = null;
            } else {
              const [w, h] = ratio.split(':').map(Number);
              cropRatio = w / h;
            }

            // æ›´æ–°è£å‰ªæ¡†
            initCropBox();
          });
        });

        document.getElementById('mobileCancelCropBtn').addEventListener('click', () => {
          exitMobileCropMode();
        });

        document.getElementById('mobileApplyCropBtn2').addEventListener('click', () => {
          applyCrop();
          exitMobileCropMode();
        });

        // ç§»åŠ¨ç«¯æ ‡ç­¾é¡µåˆ‡æ¢
        document.querySelectorAll('.mobile-tab').forEach(tab => {
          tab.addEventListener('click', (e) => {
            const targetTab = e.currentTarget.dataset.tab;

            // æ›´æ–°æ ‡ç­¾æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.mobile-tab').forEach(t => t.classList.remove('active'));
            e.currentTarget.classList.add('active');

            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.mobile-tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(`tab${targetTab.charAt(0).toUpperCase() + targetTab.slice(1)}`).classList.add('active');
          });
        });

        // ç§»åŠ¨ç«¯æ—§ç‰ˆæœ¬æ»‘å—äº‹ä»¶ (slider2 ç³»åˆ— - å¦‚æœå­˜åœ¨)
        const mobileBrightnessSlider2 = document.getElementById('mobileBrightnessSlider2');
        if (mobileBrightnessSlider2) {
          mobileBrightnessSlider2.addEventListener('input', (e) => {
            imageState.brightness = parseInt(e.target.value);
            document.getElementById('mobileBrightnessValue2').textContent = imageState.brightness + '%';
            // åŒæ­¥PCç«¯å’Œæ—§æŠ½å±‰
            document.getElementById('brightnessSlider').value = imageState.brightness;
            document.getElementById('brightnessValue').textContent = imageState.brightness + '%';
            const mobileBrightnessSlider = document.getElementById('mobileBrightnessSlider');
            if (mobileBrightnessSlider) {
              mobileBrightnessSlider.value = imageState.brightness;
              document.getElementById('mobileBrightnessValue').textContent = imageState.brightness + '%';
            }
            renderImage();
          });
        }

        const mobileContrastSlider2 = document.getElementById('mobileContrastSlider2');
        if (mobileContrastSlider2) {
          mobileContrastSlider2.addEventListener('input', (e) => {
            imageState.contrast = parseInt(e.target.value);
            document.getElementById('mobileContrastValue2').textContent = imageState.contrast + '%';
            // åŒæ­¥PCç«¯å’Œæ—§æŠ½å±‰
            document.getElementById('contrastSlider').value = imageState.contrast;
            document.getElementById('contrastValue').textContent = imageState.contrast + '%';
            const mobileContrastSlider = document.getElementById('mobileContrastSlider');
            if (mobileContrastSlider) {
              mobileContrastSlider.value = imageState.contrast;
              document.getElementById('mobileContrastValue').textContent = imageState.contrast + '%';
            }
            renderImage();
          });
        }

        const mobileSaturationSlider2 = document.getElementById('mobileSaturationSlider2');
        if (mobileSaturationSlider2) {
          mobileSaturationSlider2.addEventListener('input', (e) => {
            imageState.saturation = parseInt(e.target.value);
            document.getElementById('mobileSaturationValue2').textContent = imageState.saturation + '%';
            // åŒæ­¥PCç«¯å’Œæ—§æŠ½å±‰
            document.getElementById('saturationSlider').value = imageState.saturation;
            document.getElementById('saturationValue').textContent = imageState.saturation + '%';
            const mobileSaturationSlider = document.getElementById('mobileSaturationSlider');
            if (mobileSaturationSlider) {
              mobileSaturationSlider.value = imageState.saturation;
              document.getElementById('mobileSaturationValue').textContent = imageState.saturation + '%';
            }
            renderImage();
          });
        }

        // ç§»åŠ¨ç«¯å¯¼å‡ºæŒ‰é’® (æ—§ç‰ˆæœ¬ - å¯èƒ½å·²ä¸å­˜åœ¨)
        const mobileDownloadPNGBtn2 = document.getElementById('mobileDownloadPNGBtn2');
        if (mobileDownloadPNGBtn2) {
          mobileDownloadPNGBtn2.addEventListener('click', () => {
            downloadImage('png');
          });
        }

        const mobileDownloadJPGBtn2 = document.getElementById('mobileDownloadJPGBtn2');
        if (mobileDownloadJPGBtn2) {
          mobileDownloadJPGBtn2.addEventListener('click', () => {
            downloadImage('jpg');
          });
        }

        // ç§»åŠ¨ç«¯æ‰å¹³åŒ–å¯¼èˆªæ»‘å— (slider3 ç³»åˆ—)
        document.getElementById('mobileBrightnessSlider3').addEventListener('input', (e) => {
          imageState.brightness = parseInt(e.target.value);
          document.getElementById('mobileBrightnessValue3').textContent = imageState.brightness + '%';
          // åŒæ­¥PCç«¯
          document.getElementById('brightnessSlider').value = imageState.brightness;
          document.getElementById('brightnessValue').textContent = imageState.brightness + '%';
          renderImage();
        });

        document.getElementById('mobileContrastSlider3').addEventListener('input', (e) => {
          imageState.contrast = parseInt(e.target.value);
          document.getElementById('mobileContrastValue3').textContent = imageState.contrast + '%';
          // åŒæ­¥PCç«¯
          document.getElementById('contrastSlider').value = imageState.contrast;
          document.getElementById('contrastValue').textContent = imageState.contrast + '%';
          renderImage();
        });

        document.getElementById('mobileSaturationSlider3').addEventListener('input', (e) => {
          imageState.saturation = parseInt(e.target.value);
          document.getElementById('mobileSaturationValue3').textContent = imageState.saturation + '%';
          // åŒæ­¥PCç«¯
          document.getElementById('saturationSlider').value = imageState.saturation;
          document.getElementById('saturationValue').textContent = imageState.saturation + '%';
          renderImage();
        });

        // ç§»åŠ¨ç«¯æ‰å¹³åŒ–å¯¼èˆª - æ»¤é•œæŒ‰é’®
        document.querySelectorAll('.filter-btn-mobile').forEach(btn => {
          btn.addEventListener('click', (e) => {
            // æ›´æ–°æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.filter-btn-mobile').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');

            // åº”ç”¨æ»¤é•œ
            const filter = e.currentTarget.dataset.filterMobile;
            imageState.filter = filter;

            // åŒæ­¥PCç«¯
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            const pcFilterBtn = document.querySelector(`.filter-btn[data-filter="${filter}"]`);
            if (pcFilterBtn) pcFilterBtn.classList.add('active');

            renderImage();
          });
        });

        // ç§»åŠ¨ç«¯æ‰å¹³åŒ–å¯¼èˆª - è£å‰ªæ¯”ä¾‹æŒ‰é’®
        document.querySelectorAll('.ratio-btn-mobile').forEach(btn => {
          btn.addEventListener('click', (e) => {
            if (!currentImage) {
              showToast('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'warning');
              return;
            }

            // æ›´æ–°æ¿€æ´»çŠ¶æ€
            document.querySelectorAll('.ratio-btn-mobile').forEach(b => b.classList.remove('active'));
            e.currentTarget.classList.add('active');

            // è®¾ç½®è£å‰ªæ¯”ä¾‹
            const ratio = e.currentTarget.dataset.ratioMobile;
            if (ratio === 'free') {
              cropRatio = null;
            } else {
              const [w, h] = ratio.split(':').map(Number);
              cropRatio = w / h;
            }

            // åŒæ­¥PCç«¯
            document.querySelectorAll('.ratio-btn').forEach(b => b.classList.remove('active'));
            const pcRatioBtn = document.querySelector(`.ratio-btn[data-ratio="${ratio}"]`);
            if (pcRatioBtn) pcRatioBtn.classList.add('active');

            // åˆå§‹åŒ–è£å‰ªæ¡†
            initCropBox();
          });
        });

        // é˜²æ­¢æ»‘å—æ»‘åŠ¨æ—¶è§¦å‘é¡µé¢æ»šåŠ¨
        const preventScrollOnSliders = () => {
          const sliders = [
            'mobileBrightnessSlider3',
            'mobileContrastSlider3',
            'mobileSaturationSlider3',
            'mobileBrightnessSlider2',
            'mobileContrastSlider2',
            'mobileSaturationSlider2',
            'mobileBrightnessSlider',
            'mobileContrastSlider',
            'mobileSaturationSlider'
          ];

          sliders.forEach(sliderId => {
            const slider = document.getElementById(sliderId);
            if (slider) {
              slider.addEventListener('touchstart', (e) => {
                e.stopPropagation();
              }, { passive: true });

              slider.addEventListener('touchmove', (e) => {
                e.stopPropagation();
              }, { passive: true });
            }
          });
        };

        preventScrollOnSliders();

        // æ£€æµ‹canvas-areaæ»šåŠ¨çŠ¶æ€,æ§åˆ¶åº•éƒ¨æ¸å˜æ˜¾ç¤º
        const canvasArea = document.querySelector('.canvas-area');
        const workspace = document.querySelector('.workspace');
        if (canvasArea && workspace) {
          const handleCanvasScroll = () => {
            const scrollTop = canvasArea.scrollTop;
            const scrollHeight = canvasArea.scrollHeight;
            const clientHeight = canvasArea.clientHeight;
            const scrolledToBottom = scrollTop + clientHeight >= scrollHeight - 10; // 10pxå®¹å·®

            if (scrolledToBottom) {
              workspace.classList.add('scrolled-to-bottom');
            } else {
              workspace.classList.remove('scrolled-to-bottom');
            }
          };

          canvasArea.addEventListener('scroll', handleCanvasScroll, { passive: true });
          // åˆå§‹æ£€æŸ¥
          handleCanvasScroll();
        }

        // æŠ½å±‰æ§åˆ¶ (å·²åºŸå¼ƒ - å¦‚æœå…ƒç´ å­˜åœ¨åˆ™ç»‘å®š)
        const drawerOverlay = document.getElementById('drawerOverlay');
        const drawerHandle = document.getElementById('drawerHandle');

        if (drawerOverlay) {
          drawerOverlay.addEventListener('click', closeMobileDrawer);
        }
        if (drawerHandle) {
          drawerHandle.addEventListener('click', closeMobileDrawer);
        }
      }

      // è¿›å…¥ç§»åŠ¨ç«¯è£å‰ªæ¨¡å¼
      function enterMobileCropMode() {
        if (!currentImage) {
          showToast('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'warning');
          return;
        }

        // éšè—æ ‡ç­¾é¡µå·¥å…·æ ,æ˜¾ç¤ºè£å‰ªå·¥å…·æ 
        document.getElementById('mobileToolbarWrapper').style.display = 'none';
        document.getElementById('mobileCropToolbar').style.display = 'block';

        // åˆå§‹åŒ–è£å‰ªæ¡†
        cropRatio = null; // é»˜è®¤è‡ªç”±è£å‰ª
        initCropBox();

        showToast('ğŸ’¡ æ‹–æ‹½è°ƒæ•´è£å‰ªåŒºåŸŸ', 'info');
      }

      // é€€å‡ºç§»åŠ¨ç«¯è£å‰ªæ¨¡å¼
      function exitMobileCropMode() {
        // æ˜¾ç¤ºæ ‡ç­¾é¡µå·¥å…·æ ,éšè—è£å‰ªå·¥å…·æ 
        document.getElementById('mobileToolbarWrapper').style.display = 'flex';
        document.getElementById('mobileCropToolbar').style.display = 'none';

        // éšè—è£å‰ªæ¡†
        cropBox.classList.remove('active');
        document.getElementById('applyCropBtn').disabled = true;
        document.getElementById('mobileApplyCropBtn2').disabled = true;

        // é‡ç½®æ¯”ä¾‹é€‰æ‹©
        document.querySelectorAll('.ratio-mini-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelector('.ratio-mini-btn[data-ratio-mobile="free"]').classList.add('active');
      }

      // æ–‡ä»¶é€‰æ‹©å¤„ç†
      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
          loadImage(file);
        }
      }

      // æ‹–æ‹½å¤„ç†
      function handleDragOver(e) {
        e.preventDefault();
        uploadArea.classList.add('dragging');
      }

      function handleDragLeave(e) {
        uploadArea.classList.remove('dragging');
      }

      function handleDrop(e) {
        e.preventDefault();
        uploadArea.classList.remove('dragging');
        const file = e.dataTransfer.files[0];
        if (file && file.type.startsWith('image/')) {
          loadImage(file);
        } else {
          showToast('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶', 'error');
        }
      }

      // åŠ è½½å›¾ç‰‡
      function loadImage(file) {
        if (file.size > 10 * 1024 * 1024) {
          showToast('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡10MB', 'error');
          return;
        }

        const reader = new FileReader();
        reader.onload = (e) => {
          const img = new Image();
          img.onload = () => {
            originalImage = img;
            currentImage = img;

            // æ›´æ–°ä¿¡æ¯é¢æ¿
            document.getElementById('originalSize').textContent = `${img.width} Ã— ${img.height}`;
            document.getElementById('currentSize').textContent = `${img.width} Ã— ${img.height}`;
            document.getElementById('fileSize').textContent = formatFileSize(file.size);
            document.getElementById('fileFormat').textContent = file.type.split('/')[1].toUpperCase();

            // åˆå§‹åŒ–canvas
            initCanvas(img);

            // æ˜¾ç¤ºcanvasï¼Œéšè—ä¸Šä¼ åŒº
            uploadArea.style.display = 'none';
            canvasContainer.classList.add('active');

            // å¯ç”¨æŒ‰é’®
            enableButtons();
          };
          img.src = e.target.result;
        };
        reader.readAsDataURL(file);
      }

      // åˆå§‹åŒ–Canvas
      function initCanvas(img) {
        const maxWidth = 800;
        const maxHeight = 600;
        let width = img.width;
        let height = img.height;

        // ç­‰æ¯”ç¼©æ”¾
        if (width > maxWidth || height > maxHeight) {
          const ratio = Math.min(maxWidth / width, maxHeight / height);
          width = width * ratio;
          height = height * ratio;
        }

        canvas.width = width;
        canvas.height = height;

        renderImage();
      }

      // æ¸²æŸ“å›¾ç‰‡
      function renderImage() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ä¿å­˜ä¸Šä¸‹æ–‡
        ctx.save();

        // åº”ç”¨å˜æ¢
        const centerX = canvas.width / 2;
        const centerY = canvas.height / 2;

        ctx.translate(centerX, centerY);

        // æ—‹è½¬
        ctx.rotate((imageState.rotation * Math.PI) / 180);

        // ç¿»è½¬
        ctx.scale(
          imageState.flipH ? -1 : 1,
          imageState.flipV ? -1 : 1
        );

        // åº”ç”¨æ»¤é•œ
        applyFilters();

        // ç»˜åˆ¶å›¾ç‰‡
        ctx.drawImage(
          currentImage,
          -canvas.width / 2,
          -canvas.height / 2,
          canvas.width,
          canvas.height
        );

        ctx.restore();

        // æ›´æ–°å½“å‰å°ºå¯¸
        document.getElementById('currentSize').textContent = `${canvas.width} Ã— ${canvas.height}`;

        // ç§»åŠ¨ç«¯:å›¾ç‰‡æ¸²æŸ“åé‡æ–°æ£€æŸ¥æ»šåŠ¨çŠ¶æ€
        if (window.innerWidth <= 768) {
          setTimeout(() => {
            const canvasArea = document.querySelector('.canvas-area');
            if (canvasArea) {
              const scrollHeight = canvasArea.scrollHeight;
              const clientHeight = canvasArea.clientHeight;
              const scrolledToBottom = canvasArea.scrollTop + clientHeight >= scrollHeight - 10;

              if (scrolledToBottom) {
                canvasArea.classList.add('scrolled-to-bottom');
              } else {
                canvasArea.classList.remove('scrolled-to-bottom');
              }
            }
          }, 100); // ç­‰å¾…DOMæ›´æ–°
        }
      }

      // åº”ç”¨æ»¤é•œ
      function applyFilters() {
        let filters = [];

        // äº®åº¦
        if (imageState.brightness !== 100) {
          filters.push(`brightness(${imageState.brightness}%)`);
        }

        // å¯¹æ¯”åº¦
        if (imageState.contrast !== 100) {
          filters.push(`contrast(${imageState.contrast}%)`);
        }

        // é¥±å’Œåº¦
        if (imageState.saturation !== 100) {
          filters.push(`saturate(${imageState.saturation}%)`);
        }

        // é¢„è®¾æ»¤é•œ
        switch (imageState.filter) {
          case 'grayscale':
            filters.push('grayscale(100%)');
            break;
          case 'sepia':
            filters.push('sepia(100%)');
            break;
          case 'invert':
            filters.push('invert(100%)');
            break;
          case 'blur':
            filters.push('blur(3px)');
            break;
          case 'saturate':
            filters.push('saturate(200%)');
            break;
        }

        ctx.filter = filters.length > 0 ? filters.join(' ') : 'none';
      }

      // æ—‹è½¬å›¾ç‰‡
      function rotateImage(deg) {
        imageState.rotation = (imageState.rotation + deg) % 360;

        // äº¤æ¢å®½é«˜ - ä½¿ç”¨requestAnimationFrameä¼˜åŒ–æ€§èƒ½
        if (deg === 90 || deg === -90) {
          requestAnimationFrame(() => {
            const temp = canvas.width;
            canvas.width = canvas.height;
            canvas.height = temp;
            renderImage();
          });
        } else {
          renderImage();
        }
      }

      // æ°´å¹³ç¿»è½¬
      function flipHorizontal() {
        imageState.flipH = !imageState.flipH;
        renderImage();
      }

      // å‚ç›´ç¿»è½¬
      function flipVertical() {
        imageState.flipV = !imageState.flipV;
        renderImage();
      }

      // è£å‰ªæ¯”ä¾‹åˆ‡æ¢
      function handleRatioChange(e) {
        // æ£€æŸ¥æ˜¯å¦å·²åŠ è½½å›¾ç‰‡
        if (!currentImage) {
          showToast('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'warning');
          return;
        }

        document.querySelectorAll('.ratio-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');

        const ratio = e.target.dataset.ratio;
        if (ratio === 'free') {
          cropRatio = null;
        } else {
          const [w, h] = ratio.split(':').map(Number);
          cropRatio = w / h;
        }

        // åˆå§‹åŒ–æˆ–æ›´æ–°è£å‰ªæ¡†
        initCropBox();
      }

      // åˆå§‹åŒ–è£å‰ªæ¡†
      function initCropBox() {
        // ä½¿ç”¨canvasçš„å®é™…å°ºå¯¸(éç¼©æ”¾åçš„æ˜¾ç¤ºå°ºå¯¸)
        const canvasWidth = canvas.offsetWidth;
        const canvasHeight = canvas.offsetHeight;
        const size = Math.min(canvasWidth, canvasHeight) * 0.8;

        let width = size;
        let height = size;

        if (cropRatio) {
          if (cropRatio > 1) {
            height = width / cropRatio;
          } else {
            width = height * cropRatio;
          }
        }

        // é™åˆ¶è£å‰ªæ¡†ä¸è¶…è¿‡canvaså°ºå¯¸
        width = Math.min(width, canvasWidth);
        height = Math.min(height, canvasHeight);

        cropBox.style.width = width + 'px';
        cropBox.style.height = height + 'px';
        cropBox.style.left = (canvasWidth - width) / 2 + 'px';
        cropBox.style.top = (canvasHeight - height) / 2 + 'px';

        cropBox.classList.add('active');
        document.getElementById('applyCropBtn').disabled = false;
        const mobileApplyCropBtn2 = document.getElementById('mobileApplyCropBtn2');
        if (mobileApplyCropBtn2) {
          mobileApplyCropBtn2.disabled = false;
        }

        // ç»‘å®šè£å‰ªæ¡†æ‹–æ‹½äº‹ä»¶
        bindCropBoxEvents();
      }

      // ç»‘å®šè£å‰ªæ¡†äº¤äº’äº‹ä»¶
      function bindCropBoxEvents() {
        // ç§»é™¤æ—§çš„äº‹ä»¶ç›‘å¬å™¨(å¦‚æœå­˜åœ¨)
        cropBox.removeEventListener('mousedown', handleCropBoxMouseDown);
        cropBox.removeEventListener('touchstart', handleCropBoxTouchStart);

        // ç»‘å®šæ–°çš„äº‹ä»¶ç›‘å¬å™¨
        cropBox.addEventListener('mousedown', handleCropBoxMouseDown);
        cropBox.addEventListener('touchstart', handleCropBoxTouchStart, { passive: false });
      }

      // è£å‰ªæ¡†é¼ æ ‡æŒ‰ä¸‹
      function handleCropBoxMouseDown(e) {
        e.preventDefault();
        e.stopPropagation();

        const target = e.target;
        const canvasRect = canvas.getBoundingClientRect();
        const boxRect = cropBox.getBoundingClientRect();

        // åˆ¤æ–­æ˜¯æ‹–æ‹½è¿˜æ˜¯è°ƒæ•´å¤§å°
        if (target.classList.contains('crop-handle')) {
          isResizing = true;
          resizeHandle = target.classList[1]; // è·å–æ–¹å‘ç±»å (nw, ne, sw, se, n, s, w, e)
        } else {
          isDragging = true;
        }

        dragStart = {
          x: e.clientX,
          y: e.clientY,
          boxLeft: parseFloat(cropBox.style.left),
          boxTop: parseFloat(cropBox.style.top),
          boxWidth: parseFloat(cropBox.style.width),
          boxHeight: parseFloat(cropBox.style.height)
        };

        // ç»‘å®šå…¨å±€é¼ æ ‡ç§»åŠ¨å’Œé‡Šæ”¾äº‹ä»¶
        document.addEventListener('mousemove', handleCropBoxMouseMove);
        document.addEventListener('mouseup', handleCropBoxMouseUp);
      }

      // è£å‰ªæ¡†é¼ æ ‡ç§»åŠ¨
      function handleCropBoxMouseMove(e) {
        e.preventDefault();

        const deltaX = e.clientX - dragStart.x;
        const deltaY = e.clientY - dragStart.y;
        const canvasWidth = canvas.offsetWidth;
        const canvasHeight = canvas.offsetHeight;

        if (isDragging) {
          // æ‹–æ‹½ç§»åŠ¨
          let newLeft = dragStart.boxLeft + deltaX;
          let newTop = dragStart.boxTop + deltaY;

          // é™åˆ¶åœ¨canvasèŒƒå›´å†…
          newLeft = Math.max(0, Math.min(newLeft, canvasWidth - dragStart.boxWidth));
          newTop = Math.max(0, Math.min(newTop, canvasHeight - dragStart.boxHeight));

          cropBox.style.left = newLeft + 'px';
          cropBox.style.top = newTop + 'px';
        } else if (isResizing) {
          // è°ƒæ•´å¤§å°
          let newWidth = dragStart.boxWidth;
          let newHeight = dragStart.boxHeight;
          let newLeft = dragStart.boxLeft;
          let newTop = dragStart.boxTop;

          // æ ¹æ®æ‹–æ‹½æ–¹å‘è°ƒæ•´å°ºå¯¸
          if (resizeHandle.includes('e')) {
            newWidth = dragStart.boxWidth + deltaX;
          }
          if (resizeHandle.includes('w')) {
            newWidth = dragStart.boxWidth - deltaX;
            newLeft = dragStart.boxLeft + deltaX;
          }
          if (resizeHandle.includes('s')) {
            newHeight = dragStart.boxHeight + deltaY;
          }
          if (resizeHandle.includes('n')) {
            newHeight = dragStart.boxHeight - deltaY;
            newTop = dragStart.boxTop + deltaY;
          }

          // ä¿æŒæœ€å°å°ºå¯¸
          const minSize = 50;
          if (newWidth < minSize) {
            newWidth = minSize;
            if (resizeHandle.includes('w')) {
              newLeft = dragStart.boxLeft + dragStart.boxWidth - minSize;
            }
          }
          if (newHeight < minSize) {
            newHeight = minSize;
            if (resizeHandle.includes('n')) {
              newTop = dragStart.boxTop + dragStart.boxHeight - minSize;
            }
          }

          // å¦‚æœæœ‰å›ºå®šæ¯”ä¾‹,è°ƒæ•´é«˜åº¦
          if (cropRatio) {
            if (resizeHandle.includes('e') || resizeHandle.includes('w')) {
              newHeight = newWidth / cropRatio;
            } else if (resizeHandle.includes('n') || resizeHandle.includes('s')) {
              newWidth = newHeight * cropRatio;
            } else {
              // å¯¹è§’è°ƒæ•´,æŒ‰æ¯”ä¾‹ç¼©æ”¾
              newHeight = newWidth / cropRatio;
            }
          }

          // é™åˆ¶åœ¨canvasèŒƒå›´å†…
          if (newLeft < 0) {
            newWidth += newLeft;
            newLeft = 0;
          }
          if (newTop < 0) {
            newHeight += newTop;
            newTop = 0;
          }
          if (newLeft + newWidth > canvasWidth) {
            newWidth = canvasWidth - newLeft;
            if (cropRatio) newHeight = newWidth / cropRatio;
          }
          if (newTop + newHeight > canvasHeight) {
            newHeight = canvasHeight - newTop;
            if (cropRatio) newWidth = newHeight * cropRatio;
          }

          cropBox.style.width = newWidth + 'px';
          cropBox.style.height = newHeight + 'px';
          cropBox.style.left = newLeft + 'px';
          cropBox.style.top = newTop + 'px';
        }
      }

      // è£å‰ªæ¡†é¼ æ ‡é‡Šæ”¾
      function handleCropBoxMouseUp(e) {
        isDragging = false;
        isResizing = false;
        resizeHandle = null;

        // ç§»é™¤å…¨å±€äº‹ä»¶ç›‘å¬å™¨
        document.removeEventListener('mousemove', handleCropBoxMouseMove);
        document.removeEventListener('mouseup', handleCropBoxMouseUp);
      }

      // è§¦æ‘¸äº‹ä»¶å¤„ç†
      function handleCropBoxTouchStart(e) {
        if (e.touches.length !== 1) return;
        e.preventDefault();
        e.stopPropagation();

        const touch = e.touches[0];
        const target = e.target;

        // åˆ¤æ–­æ˜¯æ‹–æ‹½è¿˜æ˜¯è°ƒæ•´å¤§å°
        if (target.classList.contains('crop-handle')) {
          isResizing = true;
          resizeHandle = target.classList[1];
        } else {
          isDragging = true;
        }

        dragStart = {
          x: touch.clientX,
          y: touch.clientY,
          boxLeft: parseFloat(cropBox.style.left),
          boxTop: parseFloat(cropBox.style.top),
          boxWidth: parseFloat(cropBox.style.width),
          boxHeight: parseFloat(cropBox.style.height)
        };

        document.addEventListener('touchmove', handleCropBoxTouchMove, { passive: false });
        document.addEventListener('touchend', handleCropBoxTouchEnd);
      }

      function handleCropBoxTouchMove(e) {
        if (e.touches.length !== 1) return;
        e.preventDefault();

        const touch = e.touches[0];
        const deltaX = touch.clientX - dragStart.x;
        const deltaY = touch.clientY - dragStart.y;
        const canvasWidth = canvas.offsetWidth;
        const canvasHeight = canvas.offsetHeight;

        if (isDragging) {
          let newLeft = dragStart.boxLeft + deltaX;
          let newTop = dragStart.boxTop + deltaY;

          newLeft = Math.max(0, Math.min(newLeft, canvasWidth - dragStart.boxWidth));
          newTop = Math.max(0, Math.min(newTop, canvasHeight - dragStart.boxHeight));

          cropBox.style.left = newLeft + 'px';
          cropBox.style.top = newTop + 'px';
        } else if (isResizing) {
          let newWidth = dragStart.boxWidth;
          let newHeight = dragStart.boxHeight;
          let newLeft = dragStart.boxLeft;
          let newTop = dragStart.boxTop;

          if (resizeHandle.includes('e')) {
            newWidth = dragStart.boxWidth + deltaX;
          }
          if (resizeHandle.includes('w')) {
            newWidth = dragStart.boxWidth - deltaX;
            newLeft = dragStart.boxLeft + deltaX;
          }
          if (resizeHandle.includes('s')) {
            newHeight = dragStart.boxHeight + deltaY;
          }
          if (resizeHandle.includes('n')) {
            newHeight = dragStart.boxHeight - deltaY;
            newTop = dragStart.boxTop + deltaY;
          }

          const minSize = 50;
          if (newWidth < minSize) {
            newWidth = minSize;
            if (resizeHandle.includes('w')) {
              newLeft = dragStart.boxLeft + dragStart.boxWidth - minSize;
            }
          }
          if (newHeight < minSize) {
            newHeight = minSize;
            if (resizeHandle.includes('n')) {
              newTop = dragStart.boxTop + dragStart.boxHeight - minSize;
            }
          }

          if (cropRatio) {
            if (resizeHandle.includes('e') || resizeHandle.includes('w')) {
              newHeight = newWidth / cropRatio;
            } else if (resizeHandle.includes('n') || resizeHandle.includes('s')) {
              newWidth = newHeight * cropRatio;
            } else {
              newHeight = newWidth / cropRatio;
            }
          }

          if (newLeft < 0) {
            newWidth += newLeft;
            newLeft = 0;
          }
          if (newTop < 0) {
            newHeight += newTop;
            newTop = 0;
          }
          if (newLeft + newWidth > canvasWidth) {
            newWidth = canvasWidth - newLeft;
            if (cropRatio) newHeight = newWidth / cropRatio;
          }
          if (newTop + newHeight > canvasHeight) {
            newHeight = canvasHeight - newTop;
            if (cropRatio) newWidth = newHeight * cropRatio;
          }

          cropBox.style.width = newWidth + 'px';
          cropBox.style.height = newHeight + 'px';
          cropBox.style.left = newLeft + 'px';
          cropBox.style.top = newTop + 'px';
        }
      }

      function handleCropBoxTouchEnd(e) {
        isDragging = false;
        isResizing = false;
        resizeHandle = null;

        document.removeEventListener('touchmove', handleCropBoxTouchMove);
        document.removeEventListener('touchend', handleCropBoxTouchEnd);
      }

      // åº”ç”¨è£å‰ª
      function applyCrop() {
        if (!cropBox.classList.contains('active')) return;

        // è·å–è£å‰ªæ¡†ç›¸å¯¹ä½ç½®å’Œå°ºå¯¸
        const boxLeft = parseFloat(cropBox.style.left);
        const boxTop = parseFloat(cropBox.style.top);
        const boxWidth = parseFloat(cropBox.style.width);
        const boxHeight = parseFloat(cropBox.style.height);

        // è®¡ç®—canvasæ˜¾ç¤ºå°ºå¯¸å’Œå®é™…å°ºå¯¸çš„æ¯”ä¾‹
        const scaleX = canvas.width / canvas.offsetWidth;
        const scaleY = canvas.height / canvas.offsetHeight;

        // è®¡ç®—å®é™…è£å‰ªåŒºåŸŸ(canvasåæ ‡)
        const x = boxLeft * scaleX;
        const y = boxTop * scaleY;
        const width = boxWidth * scaleX;
        const height = boxHeight * scaleY;

        // åˆ›å»ºä¸´æ—¶canvas
        const tempCanvas = document.createElement('canvas');
        tempCanvas.width = width;
        tempCanvas.height = height;
        const tempCtx = tempCanvas.getContext('2d');

        // å¤åˆ¶è£å‰ªåŒºåŸŸ
        tempCtx.drawImage(canvas, x, y, width, height, 0, 0, width, height);

        // æ›´æ–°ä¸»canvas
        canvas.width = width;
        canvas.height = height;
        ctx.drawImage(tempCanvas, 0, 0);

        // æ›´æ–°currentImageå¼•ç”¨
        currentImage = canvas;

        // éšè—è£å‰ªæ¡†
        cropBox.classList.remove('active');
        document.getElementById('applyCropBtn').disabled = true;
        const mobileApplyCropBtn2 = document.getElementById('mobileApplyCropBtn2');
        if (mobileApplyCropBtn2) {
          mobileApplyCropBtn2.disabled = true;
        }

        // æ›´æ–°å°ºå¯¸ä¿¡æ¯
        document.getElementById('currentSize').textContent = `${canvas.width} Ã— ${canvas.height}`;

      }

      // æ»¤é•œåˆ‡æ¢
      function handleFilterChange(e) {
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        e.target.classList.add('active');

        imageState.filter = e.target.dataset.filter;
        renderImage();
      }

      // äº®åº¦è°ƒæ•´
      function handleBrightnessChange(e) {
        imageState.brightness = parseInt(e.target.value);
        document.getElementById('brightnessValue').textContent = imageState.brightness + '%';
        // åŒæ­¥ç§»åŠ¨ç«¯
        const mobileBrightnessSlider3 = document.getElementById('mobileBrightnessSlider3');
        if (mobileBrightnessSlider3) {
          mobileBrightnessSlider3.value = imageState.brightness;
          document.getElementById('mobileBrightnessValue3').textContent = imageState.brightness + '%';
        }
        const mobileBrightnessSlider = document.getElementById('mobileBrightnessSlider');
        if (mobileBrightnessSlider) {
          mobileBrightnessSlider.value = imageState.brightness;
          document.getElementById('mobileBrightnessValue').textContent = imageState.brightness + '%';
        }
        renderImage();
      }

      // å¯¹æ¯”åº¦è°ƒæ•´
      function handleContrastChange(e) {
        imageState.contrast = parseInt(e.target.value);
        document.getElementById('contrastValue').textContent = imageState.contrast + '%';
        // åŒæ­¥ç§»åŠ¨ç«¯
        const mobileContrastSlider3 = document.getElementById('mobileContrastSlider3');
        if (mobileContrastSlider3) {
          mobileContrastSlider3.value = imageState.contrast;
          document.getElementById('mobileContrastValue3').textContent = imageState.contrast + '%';
        }
        const mobileContrastSlider = document.getElementById('mobileContrastSlider');
        if (mobileContrastSlider) {
          mobileContrastSlider.value = imageState.contrast;
          document.getElementById('mobileContrastValue').textContent = imageState.contrast + '%';
        }
        renderImage();
      }

      // é¥±å’Œåº¦è°ƒæ•´
      function handleSaturationChange(e) {
        imageState.saturation = parseInt(e.target.value);
        document.getElementById('saturationValue').textContent = imageState.saturation + '%';
        // åŒæ­¥ç§»åŠ¨ç«¯
        const mobileSaturationSlider3 = document.getElementById('mobileSaturationSlider3');
        if (mobileSaturationSlider3) {
          mobileSaturationSlider3.value = imageState.saturation;
          document.getElementById('mobileSaturationValue3').textContent = imageState.saturation + '%';
        }
        const mobileSaturationSlider = document.getElementById('mobileSaturationSlider');
        if (mobileSaturationSlider) {
          mobileSaturationSlider.value = imageState.saturation;
          document.getElementById('mobileSaturationValue').textContent = imageState.saturation + '%';
        }
        renderImage();
      }

      // ä¸‹è½½å›¾ç‰‡
      function downloadImage(format) {
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `edited-image-${Date.now()}.${format === 'jpeg' ? 'jpg' : 'png'}`;
          a.click();
          URL.revokeObjectURL(url);
        }, `image/${format}`, 0.95);
      }

      // é‡ç½®å›¾ç‰‡
      function resetImage() {
        if (!originalImage) return;

        currentImage = originalImage;
        imageState = {
          brightness: 100,
          contrast: 100,
          saturation: 100,
          filter: 'none',
          rotation: 0,
          flipH: false,
          flipV: false
        };

        // é‡ç½®PCç«¯æ»‘å—
        document.getElementById('brightnessSlider').value = 100;
        document.getElementById('contrastSlider').value = 100;
        document.getElementById('saturationSlider').value = 100;
        document.getElementById('brightnessValue').textContent = '100%';
        document.getElementById('contrastValue').textContent = '100%';
        document.getElementById('saturationValue').textContent = '100%';

        // é‡ç½®ç§»åŠ¨ç«¯æ»‘å— (slider3 ç³»åˆ—)
        const mobileBrightnessSlider3 = document.getElementById('mobileBrightnessSlider3');
        if (mobileBrightnessSlider3) {
          mobileBrightnessSlider3.value = 100;
          document.getElementById('mobileBrightnessValue3').textContent = '100%';
        }
        const mobileContrastSlider3 = document.getElementById('mobileContrastSlider3');
        if (mobileContrastSlider3) {
          mobileContrastSlider3.value = 100;
          document.getElementById('mobileContrastValue3').textContent = '100%';
        }
        const mobileSaturationSlider3 = document.getElementById('mobileSaturationSlider3');
        if (mobileSaturationSlider3) {
          mobileSaturationSlider3.value = 100;
          document.getElementById('mobileSaturationValue3').textContent = '100%';
        }

        // é‡ç½®æ—§ç‰ˆæœ¬ç§»åŠ¨ç«¯æ»‘å— (å¦‚æœå­˜åœ¨)
        const mobileBrightnessSlider = document.getElementById('mobileBrightnessSlider');
        if (mobileBrightnessSlider) {
          mobileBrightnessSlider.value = 100;
          document.getElementById('mobileBrightnessValue').textContent = '100%';
        }
        const mobileContrastSlider = document.getElementById('mobileContrastSlider');
        if (mobileContrastSlider) {
          mobileContrastSlider.value = 100;
          document.getElementById('mobileContrastValue').textContent = '100%';
        }
        const mobileSaturationSlider = document.getElementById('mobileSaturationSlider');
        if (mobileSaturationSlider) {
          mobileSaturationSlider.value = 100;
          document.getElementById('mobileSaturationValue').textContent = '100%';
        }

        // é‡ç½®æ»¤é•œ
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.filter-btn[data-filter="none"]').forEach(btn => btn.classList.add('active'));
        document.querySelectorAll('.filter-btn-mobile').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.filter-btn-mobile[data-filter-mobile="none"]').forEach(btn => btn.classList.add('active'));

        // é‡ç½®è£å‰ªæ¯”ä¾‹
        document.querySelectorAll('.ratio-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.ratio-btn[data-ratio="free"]').forEach(btn => btn.classList.add('active'));
        document.querySelectorAll('.ratio-btn-mobile').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.ratio-btn-mobile[data-ratio-mobile="free"]').forEach(btn => btn.classList.add('active'));
        cropRatio = null;
        cropBox.classList.remove('active');

        initCanvas(originalImage);
      }

      // å¯ç”¨æŒ‰é’®
      function enableButtons() {
        // PCç«¯æŒ‰é’®
        document.getElementById('resetBtn').disabled = false;
        document.getElementById('rotateLeftBtn').disabled = false;
        document.getElementById('rotateRightBtn').disabled = false;
        document.getElementById('flipHBtn').disabled = false;
        document.getElementById('flipVBtn').disabled = false;
        document.getElementById('brightnessSlider').disabled = false;
        document.getElementById('contrastSlider').disabled = false;
        document.getElementById('saturationSlider').disabled = false;
        document.getElementById('downloadPNGBtn').disabled = false;
        document.getElementById('downloadJPGBtn').disabled = false;

        // ç§»åŠ¨ç«¯æ‰å¹³åŒ–å¯¼èˆªæŒ‰é’®
        document.getElementById('mobileRotateLeftBtn').disabled = false;
        document.getElementById('mobileRotateRightBtn').disabled = false;
        document.getElementById('mobileFlipHBtn').disabled = false;
        document.getElementById('mobileFlipVBtn').disabled = false;
        document.getElementById('mobileResetBtn2').disabled = false;
        document.getElementById('mobileUndoBtn').disabled = false;
        document.getElementById('mobileRedoBtn').disabled = false;
        document.getElementById('mobileDownloadPNGBtn3').disabled = false;
        document.getElementById('mobileDownloadJPGBtn3').disabled = false;

        // ç§»åŠ¨ç«¯æ‰å¹³åŒ–å¯¼èˆªæ»‘å—
        document.getElementById('mobileBrightnessSlider3').disabled = false;
        document.getElementById('mobileContrastSlider3').disabled = false;
        document.getElementById('mobileSaturationSlider3').disabled = false;

        // ç§»åŠ¨ç«¯è£å‰ªå·¥å…·æ 
        const mobileApplyCropBtn = document.getElementById('mobileApplyCropBtn');
        if (mobileApplyCropBtn) mobileApplyCropBtn.disabled = false;
        const mobileApplyCropBtn2 = document.getElementById('mobileApplyCropBtn2');
        if (mobileApplyCropBtn2) mobileApplyCropBtn2.disabled = false;

        // æ—§ç‰ˆæœ¬å…ƒç´  (å¦‚æœå­˜åœ¨)
        const mobileBrightnessSlider = document.getElementById('mobileBrightnessSlider');
        if (mobileBrightnessSlider) mobileBrightnessSlider.disabled = false;
        const mobileContrastSlider = document.getElementById('mobileContrastSlider');
        if (mobileContrastSlider) mobileContrastSlider.disabled = false;
        const mobileSaturationSlider = document.getElementById('mobileSaturationSlider');
        if (mobileSaturationSlider) mobileSaturationSlider.disabled = false;

        const mobileBrightnessSlider2 = document.getElementById('mobileBrightnessSlider2');
        if (mobileBrightnessSlider2) mobileBrightnessSlider2.disabled = false;
        const mobileContrastSlider2 = document.getElementById('mobileContrastSlider2');
        if (mobileContrastSlider2) mobileContrastSlider2.disabled = false;
        const mobileSaturationSlider2 = document.getElementById('mobileSaturationSlider2');
        if (mobileSaturationSlider2) mobileSaturationSlider2.disabled = false;

        const mobileDownloadPNGBtn = document.getElementById('mobileDownloadPNGBtn');
        if (mobileDownloadPNGBtn) mobileDownloadPNGBtn.disabled = false;
        const mobileDownloadJPGBtn = document.getElementById('mobileDownloadJPGBtn');
        if (mobileDownloadJPGBtn) mobileDownloadJPGBtn.disabled = false;
        const mobileDownloadPNGBtn2 = document.getElementById('mobileDownloadPNGBtn2');
        if (mobileDownloadPNGBtn2) mobileDownloadPNGBtn2.disabled = false;
        const mobileDownloadJPGBtn2 = document.getElementById('mobileDownloadJPGBtn2');
        if (mobileDownloadJPGBtn2) mobileDownloadJPGBtn2.disabled = false;

        // æ›´æ–°æ’¤é”€/é‡åšæŒ‰é’®çŠ¶æ€
        updateHistoryButtons();
      }

      // ä¿å­˜å†å²çŠ¶æ€
      function saveHistory() {
        // æ¸…é™¤å½“å‰ç´¢å¼•ä¹‹åçš„å†å²
        history = history.slice(0, historyIndex + 1);

        // ä¿å­˜å½“å‰çŠ¶æ€
        const state = {
          imageData: canvas.toDataURL(),
          width: canvas.width,
          height: canvas.height,
          state: { ...imageState }
        };

        history.push(state);

        // é™åˆ¶å†å²è®°å½•æ•°é‡
        if (history.length > MAX_HISTORY) {
          history.shift();
        } else {
          historyIndex++;
        }

        updateHistoryButtons();
      }

      // æ’¤é”€
      function undo() {
        if (historyIndex > 0) {
          historyIndex--;
          restoreHistory();
        }
      }

      // é‡åš
      function redo() {
        if (historyIndex < history.length - 1) {
          historyIndex++;
          restoreHistory();
        }
      }

      // æ¢å¤å†å²çŠ¶æ€
      function restoreHistory() {
        if (historyIndex < 0 || historyIndex >= history.length) return;

        const state = history[historyIndex];
        const img = new Image();
        img.onload = () => {
          canvas.width = state.width;
          canvas.height = state.height;
          ctx.clearRect(0, 0, canvas.width, canvas.height);
          ctx.drawImage(img, 0, 0);

          // æ¢å¤çŠ¶æ€
          imageState = { ...state.state };

          // åŒæ­¥UI
          syncUIFromState();
          updateHistoryButtons();
        };
        img.src = state.imageData;
      }

      // ä»çŠ¶æ€åŒæ­¥UI
      function syncUIFromState() {
        // PCç«¯
        document.getElementById('brightnessSlider').value = imageState.brightness;
        document.getElementById('contrastSlider').value = imageState.contrast;
        document.getElementById('saturationSlider').value = imageState.saturation;
        document.getElementById('brightnessValue').textContent = imageState.brightness + '%';
        document.getElementById('contrastValue').textContent = imageState.contrast + '%';
        document.getElementById('saturationValue').textContent = imageState.saturation + '%';

        // ç§»åŠ¨ç«¯ (slider3 ç³»åˆ—)
        const mobileBrightnessSlider3 = document.getElementById('mobileBrightnessSlider3');
        if (mobileBrightnessSlider3) {
          mobileBrightnessSlider3.value = imageState.brightness;
          document.getElementById('mobileBrightnessValue3').textContent = imageState.brightness + '%';
        }
        const mobileContrastSlider3 = document.getElementById('mobileContrastSlider3');
        if (mobileContrastSlider3) {
          mobileContrastSlider3.value = imageState.contrast;
          document.getElementById('mobileContrastValue3').textContent = imageState.contrast + '%';
        }
        const mobileSaturationSlider3 = document.getElementById('mobileSaturationSlider3');
        if (mobileSaturationSlider3) {
          mobileSaturationSlider3.value = imageState.saturation;
          document.getElementById('mobileSaturationValue3').textContent = imageState.saturation + '%';
        }

        // æ—§ç‰ˆæœ¬ç§»åŠ¨ç«¯æ»‘å— (å¦‚æœå­˜åœ¨)
        const mobileBrightnessSlider = document.getElementById('mobileBrightnessSlider');
        if (mobileBrightnessSlider) {
          mobileBrightnessSlider.value = imageState.brightness;
          document.getElementById('mobileBrightnessValue').textContent = imageState.brightness + '%';
        }
        const mobileContrastSlider = document.getElementById('mobileContrastSlider');
        if (mobileContrastSlider) {
          mobileContrastSlider.value = imageState.contrast;
          document.getElementById('mobileContrastValue').textContent = imageState.contrast + '%';
        }
        const mobileSaturationSlider = document.getElementById('mobileSaturationSlider');
        if (mobileSaturationSlider) {
          mobileSaturationSlider.value = imageState.saturation;
          document.getElementById('mobileSaturationValue').textContent = imageState.saturation + '%';
        }

        // æ»¤é•œ
        document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll(`.filter-btn[data-filter="${imageState.filter}"]`).forEach(btn => btn.classList.add('active'));
        document.querySelectorAll('.filter-btn-mobile').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll(`.filter-btn-mobile[data-filter-mobile="${imageState.filter}"]`).forEach(btn => btn.classList.add('active'));
      }

      // æ›´æ–°å†å²æŒ‰é’®çŠ¶æ€
      function updateHistoryButtons() {
        const undoBtn = document.getElementById('undoBtn');
        const redoBtn = document.getElementById('redoBtn');
        const mobileUndoBtn = document.getElementById('mobileUndoBtn');
        const mobileRedoBtn = document.getElementById('mobileRedoBtn');

        if (undoBtn) undoBtn.disabled = historyIndex <= 0;
        if (redoBtn) redoBtn.disabled = historyIndex >= history.length - 1;
        if (mobileUndoBtn) mobileUndoBtn.disabled = historyIndex <= 0;
        if (mobileRedoBtn) mobileRedoBtn.disabled = historyIndex >= history.length - 1;
      }

      // æ‰“å¼€ç§»åŠ¨ç«¯æŠ½å±‰
      function openMobileDrawer() {
        console.log('openMobileDrawer å‡½æ•°è¢«è°ƒç”¨');
        const drawer = document.getElementById('mobileDrawer');
        const overlay = document.getElementById('drawerOverlay');

        console.log('æŠ½å±‰å…ƒç´ :', drawer);
        console.log('é®ç½©å…ƒç´ :', overlay);

        if (!drawer || !overlay) {
          console.error('æŠ½å±‰å…ƒç´ æœªæ‰¾åˆ°');
          return;
        }

        console.log('æ·»åŠ  active ç±»');
        drawer.classList.add('active');
        overlay.classList.add('active');

        console.log('æŠ½å±‰ç±»å:', drawer.className);
        console.log('é®ç½©ç±»å:', overlay.className);

        // ç¦æ­¢bodyæ»šåŠ¨
        document.body.style.overflow = 'hidden';
      }

      // å…³é—­ç§»åŠ¨ç«¯æŠ½å±‰ (å·²åºŸå¼ƒå‡½æ•°)
      function closeMobileDrawer() {
        const drawer = document.getElementById('mobileDrawer');
        const overlay = document.getElementById('drawerOverlay');
        if (drawer) drawer.classList.remove('active');
        if (overlay) overlay.classList.remove('active');
        // æ¢å¤bodyæ»šåŠ¨
        document.body.style.overflow = '';
      }

      // Toastæç¤º
      // Toast è‡ªåŠ¨éšè—å®šæ—¶å™¨
      let toastTimer = null;

      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toastIcon');
        const msg = document.getElementById('toastMessage');

        // æ¸…é™¤ä¹‹å‰çš„å®šæ—¶å™¨
        if (toastTimer) {
          clearTimeout(toastTimer);
        }

        msg.textContent = message;
        toast.className = 'toast ' + type;

        // è®¾ç½®å›¾æ ‡
        if (type === 'success') {
          icon.textContent = 'âœ…';
        } else if (type === 'error') {
          icon.textContent = 'âŒ';
        } else if (type === 'warning') {
          icon.textContent = 'âš ï¸';
        } else if (type === 'info') {
          icon.textContent = 'â„¹ï¸';
        }

        // ç§»åŠ¨ç«¯éœ‡åŠ¨åé¦ˆ
        if ('vibrate' in navigator && window.innerWidth <= 768) {
          if (type === 'error') {
            navigator.vibrate([50, 30, 50]); // é”™è¯¯:ä¸¤æ¬¡çŸ­éœ‡
          } else if (type === 'warning') {
            navigator.vibrate(30); // è­¦å‘Š:å•æ¬¡çŸ­éœ‡
          } else if (type === 'success') {
            navigator.vibrate(20); // æˆåŠŸ:è½»å¾®éœ‡åŠ¨
          }
        }

        // æ˜¾ç¤º Toast
        toast.classList.add('show');

        // ç§»åŠ¨ç«¯:æ·»åŠ è§¦æ‘¸å…³é—­åŠŸèƒ½
        const isMobile = window.innerWidth <= 768;
        if (isMobile) {
          // è§¦æ‘¸å…³é—­
          const handleToastTouch = () => {
            toast.classList.remove('show');
            toast.removeEventListener('click', handleToastTouch);
          };
          toast.addEventListener('click', handleToastTouch);

          // æ»‘åŠ¨å…³é—­
          let startY = 0;
          let currentY = 0;

          const handleTouchStart = (e) => {
            startY = e.touches[0].clientY;
          };

          const handleTouchMove = (e) => {
            currentY = e.touches[0].clientY;
            const deltaY = currentY - startY;

            // å‘ä¸‹æ»‘åŠ¨è¶…è¿‡ 30px æ—¶å…³é—­
            if (deltaY > 30) {
              toast.classList.remove('show');
              toast.removeEventListener('touchstart', handleTouchStart);
              toast.removeEventListener('touchmove', handleTouchMove);
            }
          };

          toast.addEventListener('touchstart', handleTouchStart, { passive: true });
          toast.addEventListener('touchmove', handleTouchMove, { passive: true });
        }

        // è‡ªåŠ¨éšè— (ç§»åŠ¨ç«¯ 2.5 ç§’,æ¡Œé¢ç«¯ 3 ç§’)
        const duration = isMobile ? 2500 : 3000;
        toastTimer = setTimeout(() => {
          toast.classList.remove('show');
        }, duration);
      }

      // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
      function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
      }

      init();
    </script>
  </body>
</html>
