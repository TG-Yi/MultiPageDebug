<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>æµ·æŠ¥è®¾è®¡å·¥å…· - å¼€å‘å·¥å…·ç®±</title>
    <link rel="icon" type="image/svg+xml" href="../../favicon.svg" />
    <link rel="alternate icon" href="../../favicon.ico" />
    <link rel="stylesheet" href="../../shared/styles/common.css" />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: linear-gradient(
          135deg,
          #1e3a5f 0%,
          #3d5a80 20%,
          #ee6c4d 50%,
          #f4a261 75%,
          #e9c46a 100%
        );
        min-height: 100vh;
        padding: 20px;
      }

      .main-container {
        max-width: 1600px;
        margin: 0 auto;
        display: flex;
        flex-direction: column;
        gap: 20px;
        width: 100%;
      }

      .header {
        text-align: center;
        color: white;
        padding: 20px;
      }

      .header h1 {
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
        text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
      }

      .header p {
        font-size: 14px;
        opacity: 0.9;
      }

      .workspace {
        display: grid;
        grid-template-columns: minmax(260px, 280px) 1fr minmax(260px, 280px);
        gap: 20px;
        min-height: 600px;
        width: 100%;
        overflow: visible;
      }

      /* å·¦ä¾§å·¥å…·æ  */
      .toolbar {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-height: calc(100vh - 220px);
        overflow-y: auto;
        min-width: 0;
      }

      .tool-section {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .tool-section-title {
        font-size: 14px;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 8px;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .tool-btn {
        padding: 14px 18px;
        background: linear-gradient(135deg, #ee6c4d 0%, #f4a261 100%);
        border: none;
        border-radius: 12px;
        color: white;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        display: flex;
        align-items: center;
        gap: 8px;
        justify-content: center;
        min-height: 44px; /* ç¡®ä¿è§¦æ‘¸ç›®æ ‡è¶³å¤Ÿå¤§ */
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }

      .tool-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(238, 108, 77, 0.3);
      }

      .tool-btn:active {
        transform: scale(0.97);
        box-shadow: 0 2px 10px rgba(238, 108, 77, 0.3);
      }

      .tool-btn.secondary {
        background: rgba(0, 0, 0, 0.05);
        color: var(--text-color);
      }

      .tool-btn.secondary:hover {
        background: rgba(0, 0, 0, 0.1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .preset-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      .preset-btn {
        padding: 12px;
        background: rgba(0, 0, 0, 0.03);
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        font-size: 12px;
        text-align: center;
        min-height: 44px; /* ç¡®ä¿è§¦æ‘¸ç›®æ ‡è¶³å¤Ÿå¤§ */
        display: flex;
        align-items: center;
        justify-content: center;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }

      .preset-btn:hover {
        background: rgba(238, 108, 77, 0.1);
        border-color: #ee6c4d;
        transform: translateY(-1px);
      }

      .preset-btn:active {
        transform: scale(0.97);
        background: rgba(238, 108, 77, 0.15);
      }

      .preset-btn.active {
        background: rgba(238, 108, 77, 0.2);
        border-color: #ee6c4d;
        font-weight: 600;
      }

      /* ä¸­é—´ç”»å¸ƒåŒºåŸŸ */
      .canvas-area {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 30px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        min-height: 600px;
        overflow: auto;
        min-width: 0;
      }

      .canvas-wrapper {
        position: relative;
        background: white;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15);
        overflow: hidden;
        max-width: 100%;
        max-height: calc(100vh - 280px);
      }

      #posterCanvas {
        display: block;
        cursor: crosshair;
        max-width: 100%;
        height: auto;
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        touch-action: none;
      }

      #posterCanvas.dragging {
        cursor: grabbing !important;
      }

      #posterCanvas.resizing {
        cursor: nwse-resize !important;
      }

      .canvas-controls {
        position: absolute;
        top: 20px;
        left: 20px;
        display: flex;
        gap: 10px;
        z-index: 100;
      }

      .canvas-control-btn {
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.95);
        border: 2px solid rgba(238, 108, 77, 0.1);
        border-radius: 12px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: auto;
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }

      .canvas-control-btn:hover {
        background: white;
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.15);
        border-color: rgba(238, 108, 77, 0.3);
      }

      .canvas-control-btn:active {
        transform: scale(0.92);
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      /* é¢„è§ˆæ¨¡æ€æ¡† */
      .preview-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 10002; /* æ¯”æŠ½å±‰æ›´é«˜ */
        align-items: center;
        justify-content: center;
        padding: 20px;
        -webkit-tap-highlight-color: transparent;
      }

      .preview-modal.active {
        display: flex;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .preview-content {
        max-width: 90vw;
        max-height: 90vh;
        position: relative;
        animation: zoomIn 0.3s ease;
      }

      @keyframes zoomIn {
        from {
          transform: scale(0.9);
          opacity: 0;
        }
        to {
          transform: scale(1);
          opacity: 1;
        }
      }

      .preview-canvas {
        max-width: 100%;
        max-height: 90vh;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        border-radius: 8px;
      }

      .preview-close {
        position: absolute;
        top: -50px;
        right: 0;
        width: 44px;
        height: 44px;
        background: rgba(255, 255, 255, 0.95);
        border: none;
        border-radius: 50%;
        cursor: pointer;
        font-size: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        color: var(--text-color);
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }

      .preview-close:hover {
        background: white;
        transform: scale(1.1) rotate(90deg);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }

      .preview-close:active {
        transform: scale(1) rotate(90deg);
      }

      /* å³ä¾§å±æ€§é¢æ¿ */
      .properties-panel {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        gap: 20px;
        max-height: calc(100vh - 220px);
        overflow-y: auto;
        min-width: 0;
      }

      .property-group {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .property-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 4px;
      }

      .property-input {
        padding: 10px 12px;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        font-size: 14px;
        transition: all 0.3s ease;
        width: 100%;
      }

      .property-input:focus {
        outline: none;
        border-color: #ee6c4d;
        box-shadow: 0 0 0 3px rgba(238, 108, 77, 0.1);
      }

      .property-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .color-picker-wrapper {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .color-picker {
        width: 50px;
        height: 40px;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        cursor: pointer;
      }

      .font-size-input {
        width: 80px;
      }

      .layer-list {
        display: flex;
        flex-direction: column;
        gap: 8px;
        max-height: 300px;
        overflow-y: auto;
      }

      .layer-item {
        padding: 12px;
        background: rgba(0, 0, 0, 0.03);
        border: 2px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: all 0.3s ease;
      }

      .layer-item:hover {
        background: rgba(238, 108, 77, 0.1);
        border-color: #ee6c4d;
      }

      .layer-item.active {
        background: rgba(238, 108, 77, 0.2);
        border-color: #ee6c4d;
        font-weight: 600;
      }

      .layer-actions {
        display: flex;
        gap: 6px;
      }

      .layer-action-btn {
        width: 28px;
        height: 28px;
        background: rgba(0, 0, 0, 0.05);
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .layer-action-btn:hover {
        background: rgba(238, 108, 77, 0.2);
      }

      .empty-state {
        text-align: center;
        color: var(--text-light);
        padding: 30px;
        font-size: 14px;
      }

      /* ç§»åŠ¨ç«¯æ‚¬æµ®æŒ‰é’® */
      .mobile-fab {
        display: none;
        position: absolute;
        top: 20px;
        right: 20px;
        z-index: 100;
        flex-direction: row;
        gap: 10px;
      }

      .fab-btn {
        width: 44px;
        height: 44px;
        border-radius: 12px;
        background: linear-gradient(135deg, #ee6c4d 0%, #f4a261 100%);
        color: white;
        border: none;
        box-shadow: 0 4px 12px rgba(238, 108, 77, 0.4);
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: auto;
        -webkit-tap-highlight-color: transparent;
        user-select: none;
        -webkit-user-select: none;
        touch-action: manipulation;
      }

      .fab-btn:active {
        transform: scale(0.92);
        box-shadow: 0 2px 8px rgba(238, 108, 77, 0.4);
      }

      .fab-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(238, 108, 77, 0.5);
      }

      /* ç§»åŠ¨ç«¯æŠ½å±‰é¢æ¿ */
      .drawer-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000; /* æ¯”è¿”å›é¦–é¡µæŒ‰é’®(9999)æ›´é«˜ */
        opacity: 0;
        transition: opacity 0.3s ease;
        -webkit-tap-highlight-color: transparent;
      }

      .drawer-overlay.active {
        display: block;
        opacity: 1;
      }

      .drawer {
        display: none;
        position: fixed;
        top: 0;
        right: 0; /* é»˜è®¤ä»å³ä¾§æ»‘å‡º */
        height: 100vh;
        width: 85%;
        max-width: 360px;
        background: white;
        z-index: 10001; /* åœ¨é®ç½©å±‚ä¹‹ä¸Š */
        overflow-y: auto;
        padding: 20px;
        padding-bottom: 40px; /* åº•éƒ¨ç•™ç™½ï¼Œé¿å…å†…å®¹è¢«é®æŒ¡ */
        box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
        -webkit-overflow-scrolling: touch;
      }

      .drawer.active {
        display: block;
        animation: slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1) forwards;
      }

      /* ç¦æ­¢é¡µé¢æ»šåŠ¨ï¼ˆå½“æŠ½å±‰æ‰“å¼€æ—¶ï¼‰ */
      body.drawer-open {
        overflow: hidden;
        position: fixed;
        width: 100%;
        height: 100%;
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
        }
        to {
          transform: translateX(0);
        }
      }

      .drawer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f0f0f0;
      }

      .drawer-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-color);
      }

      .drawer-close {
        width: 36px;
        height: 36px;
        border: none;
        background: rgba(238, 108, 77, 0.1);
        border-radius: 50%;
        cursor: pointer;
        font-size: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        color: var(--primary-color);
        -webkit-tap-highlight-color: transparent;
      }

      .drawer-close:hover {
        background: rgba(238, 108, 77, 0.2);
        transform: rotate(90deg);
      }

      .drawer-close:active {
        background: rgba(238, 108, 77, 0.3);
        transform: rotate(90deg) scale(0.95);
      }

      /* æŠ½å±‰å†…çš„ç§»åŠ¨ç«¯å·¥å…·æŒ‰é’® */
      .drawer .tool-btn {
        width: 100%;
        justify-content: flex-start;
      }

      .drawer .tool-section {
        margin-bottom: 20px;
      }

      .drawer .tool-section-title {
        font-size: 14px;
        font-weight: 700;
        color: var(--text-color);
        margin-bottom: 12px;
        display: flex;
        align-items: center;
        gap: 6px;
      }

      /* ç§»åŠ¨ç«¯å±æ€§é¢æ¿ä¼˜åŒ– */
      .drawer .property-group {
        margin-bottom: 16px;
        padding: 16px;
        background: rgba(238, 108, 77, 0.03);
        border-radius: 12px;
        border: 1px solid rgba(238, 108, 77, 0.08);
      }

      .drawer .property-group:last-child {
        margin-bottom: 0;
      }

      /* åµŒå¥—çš„ property-group ä¸éœ€è¦èƒŒæ™¯ */
      .drawer .property-group .property-group {
        background: transparent;
        border: none;
        padding: 0;
        margin-bottom: 12px;
      }

      .drawer .property-group .property-group:last-child {
        margin-bottom: 0;
      }

      .drawer .property-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-color);
        margin-bottom: 8px;
        display: block;
      }

      .drawer .property-input {
        padding: 12px;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        font-size: 15px;
        width: 100%;
        min-height: 44px; /* ç¡®ä¿è§¦æ‘¸ç›®æ ‡è¶³å¤Ÿå¤§ */
        -webkit-tap-highlight-color: transparent;
        transition: all 0.3s ease;
      }

      .drawer .property-input:focus {
        outline: none;
        border-color: #ee6c4d;
        box-shadow: 0 0 0 3px rgba(238, 108, 77, 0.1);
      }

      .drawer .property-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 16px;
      }

      .drawer .property-row:last-child {
        margin-bottom: 0;
      }

      /* ç§»åŠ¨ç«¯é¢œè‰²é€‰æ‹©å™¨ä¼˜åŒ– */
      .drawer .color-picker-wrapper {
        display: flex;
        gap: 10px;
        align-items: stretch;
      }

      .drawer .color-picker {
        width: 60px;
        height: 44px;
        border: 2px solid rgba(0, 0, 0, 0.1);
        border-radius: 10px;
        cursor: pointer;
        -webkit-tap-highlight-color: transparent;
        flex-shrink: 0;
      }

      .drawer .color-picker-wrapper .property-input {
        flex: 1;
        min-width: 0;
      }

      /* ç§»åŠ¨ç«¯å›¾å±‚åˆ—è¡¨ä¼˜åŒ– */
      .drawer .layer-list {
        max-height: 250px;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
        margin: -8px; /* æŠµæ¶ˆå†…éƒ¨ margin */
        padding: 8px;
      }

      .drawer .layer-list::-webkit-scrollbar {
        width: 4px;
      }

      .drawer .layer-list::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 2px;
      }

      .drawer .layer-list::-webkit-scrollbar-thumb {
        background: rgba(238, 108, 77, 0.3);
        border-radius: 2px;
      }

      .drawer .layer-list::-webkit-scrollbar-thumb:hover {
        background: rgba(238, 108, 77, 0.5);
      }

      .drawer .layer-item {
        padding: 14px;
        margin-bottom: 8px;
        background: rgba(0, 0, 0, 0.03);
        border: 2px solid transparent;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        min-height: 44px;
        -webkit-tap-highlight-color: transparent;
      }

      .drawer .layer-item:last-child {
        margin-bottom: 0;
      }

      .drawer .layer-item:active {
        transform: scale(0.98);
      }

      .drawer .layer-item.active {
        background: rgba(238, 108, 77, 0.15);
        border-color: #ee6c4d;
        font-weight: 600;
      }

      .drawer .empty-state {
        padding: 40px 20px;
        text-align: center;
        color: var(--text-light);
        font-size: 14px;
        line-height: 1.6;
      }

      /* ç§»åŠ¨ç«¯ select ä¸‹æ‹‰æ¡†ä¼˜åŒ– */
      .drawer select.property-input {
        appearance: none;
        -webkit-appearance: none;
        -moz-appearance: none;
        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%23666' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
        background-repeat: no-repeat;
        background-position: right 12px center;
        background-size: 12px;
        padding-right: 36px;
      }

      /* ç§»åŠ¨ç«¯æ•°å­—è¾“å…¥æ¡†ä¼˜åŒ– */
      .drawer input[type="number"].property-input {
        -moz-appearance: textfield;
      }

      .drawer input[type="number"].property-input::-webkit-outer-spin-button,
      .drawer input[type="number"].property-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      /* ç§»åŠ¨ç«¯åˆ é™¤æŒ‰é’®ä¼˜åŒ– */
      .drawer .tool-btn.secondary {
        background: linear-gradient(135deg, #e76f51 0%, #f4a261 100%);
        color: white;
        border: none;
        box-shadow: 0 2px 8px rgba(231, 111, 81, 0.3);
      }

      .drawer .tool-btn.secondary:active {
        transform: scale(0.97);
        box-shadow: 0 1px 4px rgba(231, 111, 81, 0.3);
      }

      /* ç§»åŠ¨ç«¯å›¾å±‚æ“ä½œæŒ‰é’®ä¼˜åŒ– */
      .drawer .layer-actions {
        display: flex;
        gap: 8px;
      }

      .drawer .layer-action-btn {
        width: 36px;
        height: 36px;
        background: rgba(238, 108, 77, 0.1);
        border: 2px solid rgba(238, 108, 77, 0.2);
        border-radius: 8px;
        cursor: pointer;
        font-size: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
        -webkit-tap-highlight-color: transparent;
        flex-shrink: 0;
      }

      .drawer .layer-action-btn:active {
        transform: scale(0.9);
        background: rgba(238, 108, 77, 0.2);
      }

      .drawer .layer-info {
        flex: 1;
        min-width: 0;
        overflow: hidden;
      }

      .drawer .layer-name {
        font-size: 14px;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 1400px) {
        .workspace {
          grid-template-columns: 240px 1fr 240px;
        }
      }

      @media (max-width: 1200px) {
        .workspace {
          grid-template-columns: 1fr;
          grid-template-rows: auto auto auto;
          gap: 15px;
        }

        .toolbar,
        .properties-panel {
          max-height: none;
          overflow-y: visible;
        }

        .canvas-wrapper {
          max-height: none;
        }
      }

      @media (max-width: 768px) {
        body {
          padding: 0;
        }

        .header {
          padding: 15px 10px;
        }

        .header h1 {
          font-size: 24px;
        }

        .header p {
          font-size: 13px;
        }

        .main-container {
          gap: 0;
        }

        .workspace {
          grid-template-columns: 1fr;
          grid-template-rows: 1fr;
          gap: 0;
          min-height: calc(100vh - 100px);
        }

        /* éšè—æ¡Œé¢ç‰ˆä¾§è¾¹æ  */
        .toolbar,
        .properties-panel {
          display: none !important;
        }

        /* æ˜¾ç¤ºç§»åŠ¨ç«¯æ§ä»¶ */
        .mobile-fab {
          display: flex;
        }

        /* ç”»å¸ƒåŒºåŸŸå…¨å±æ˜¾ç¤º */
        .canvas-area {
          padding: 10px;
          border-radius: 0;
          min-height: calc(100vh - 100px);
          grid-column: 1;
          grid-row: 1;
          position: relative;
          overflow: visible;
        }

        .canvas-wrapper {
          max-height: calc(100vh - 120px);
        }

        #posterCanvas {
          max-width: 100%;
        }

        .preset-grid {
          grid-template-columns: repeat(2, 1fr);
          gap: 8px;
        }

        .preset-btn {
          padding: 8px 12px;
          font-size: 12px;
        }

        /* ç§»åŠ¨ç«¯ç”»å¸ƒæ§åˆ¶æŒ‰é’®è°ƒæ•´ */
        .canvas-controls {
          top: 10px;
          left: 10px;
        }

        .mobile-fab {
          top: 10px;
          right: 10px;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 20px;
        }

        .header p {
          font-size: 12px;
        }

        .drawer {
          width: 90%;
          max-width: 100%;
        }

        .canvas-control-btn {
          width: 40px;
          height: 40px;
          font-size: 16px;
        }

        .fab-btn {
          width: 40px;
          height: 40px;
          font-size: 18px;
        }

        .canvas-controls {
          top: 8px;
          left: 8px;
          gap: 8px;
        }

        .mobile-fab {
          top: 8px;
          right: 8px;
          gap: 8px;
        }
      }

      /* æ»šåŠ¨æ¡æ ·å¼ */
      .toolbar::-webkit-scrollbar,
      .properties-panel::-webkit-scrollbar,
      .layer-list::-webkit-scrollbar {
        width: 6px;
      }

      .toolbar::-webkit-scrollbar-track,
      .properties-panel::-webkit-scrollbar-track,
      .layer-list::-webkit-scrollbar-track {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 3px;
      }

      .toolbar::-webkit-scrollbar-thumb,
      .properties-panel::-webkit-scrollbar-thumb,
      .layer-list::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2);
        border-radius: 3px;
      }

      /* è¾“å…¥æ–‡ä»¶éšè— */
      .file-input {
        display: none;
      }

      /* æç¤ºä¿¡æ¯ */
      .toast {
        position: fixed;
        top: 20px;
        right: 20px;
        background: white;
        padding: 16px 24px;
        border-radius: 12px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        z-index: 1000;
        display: none;
        align-items: center;
        gap: 12px;
        animation: slideIn 0.3s ease;
      }

      .toast.show {
        display: flex;
      }

      @keyframes slideIn {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .toast.success {
        border-left: 4px solid #2a9d8f;
      }

      .toast.error {
        border-left: 4px solid #e76f51;
      }

      .toast-icon {
        font-size: 24px;
      }

      .toast-message {
        font-size: 14px;
        font-weight: 600;
        color: var(--text-color);
      }
    </style>
  </head>
  <body>
    <a href="../../index.html" class="back-home-btn">è¿”å›é¦–é¡µ</a>

    <!-- æç¤ºä¿¡æ¯ -->
    <div class="toast" id="toast">
      <span class="toast-icon" id="toastIcon">âœ…</span>
      <span class="toast-message" id="toastMessage">æ“ä½œæˆåŠŸ</span>
    </div>

    <div class="main-container">
      <!-- å¤´éƒ¨ -->
      <div class="header">
        <h1>ğŸ¨ æµ·æŠ¥è®¾è®¡å·¥å…·</h1>
        <p>åœ¨çº¿è®¾è®¡æµ·æŠ¥ï¼Œæ”¯æŒæ–‡æœ¬ã€å›¾ç‰‡ã€å½¢çŠ¶ç­‰å…ƒç´ ï¼Œå¯¼å‡ºé«˜æ¸…å›¾ç‰‡</p>
      </div>

      <!-- å·¥ä½œåŒº -->
      <div class="workspace">
        <!-- å·¦ä¾§å·¥å…·æ  -->
        <div class="toolbar">
          <div class="tool-section">
            <div class="tool-section-title">ğŸ“ ç”»å¸ƒå°ºå¯¸</div>
            <div class="preset-grid">
              <div class="preset-btn" data-size="800,600">800Ã—600</div>
              <div class="preset-btn active" data-size="1080,1920">1080Ã—1920<br/><small>ç«–å±</small></div>
              <div class="preset-btn" data-size="1920,1080">1920Ã—1080<br/><small>æ¨ªå±</small></div>
              <div class="preset-btn" data-size="1080,1080">1080Ã—1080<br/><small>æ–¹å½¢</small></div>
            </div>
          </div>

          <div class="tool-section">
            <div class="tool-section-title">ğŸ¨ èƒŒæ™¯è®¾ç½®</div>
            <button class="tool-btn" id="setBgColor">
              <span>ğŸ¨</span>
              <span>çº¯è‰²èƒŒæ™¯</span>
            </button>
            <button class="tool-btn" id="uploadBgImage">
              <span>ğŸ–¼ï¸</span>
              <span>å›¾ç‰‡èƒŒæ™¯</span>
            </button>
            <input type="file" class="file-input" id="bgImageInput" accept="image/*" />
          </div>

          <div class="tool-section">
            <div class="tool-section-title">â• æ·»åŠ å…ƒç´ </div>
            <button class="tool-btn" id="addText">
              <span>ğŸ“</span>
              <span>æ·»åŠ æ–‡æœ¬</span>
            </button>
            <button class="tool-btn" id="uploadImage">
              <span>ğŸ–¼ï¸</span>
              <span>ä¸Šä¼ å›¾ç‰‡</span>
            </button>
            <input type="file" class="file-input" id="imageInput" accept="image/*" />
            <button class="tool-btn" id="addRect">
              <span>â¬œ</span>
              <span>æ·»åŠ çŸ©å½¢</span>
            </button>
            <button class="tool-btn" id="addCircle">
              <span>â­•</span>
              <span>æ·»åŠ åœ†å½¢</span>
            </button>
          </div>

          <div class="tool-section">
            <div class="tool-section-title">ğŸ’¾ æ–‡ä»¶æ“ä½œ</div>
            <button class="tool-btn secondary" id="clearCanvas">
              <span>ğŸ—‘ï¸</span>
              <span>æ¸…ç©ºç”»å¸ƒ</span>
            </button>
            <button class="tool-btn" id="exportPNG">
              <span>â¬‡ï¸</span>
              <span>å¯¼å‡ºPNG</span>
            </button>
            <button class="tool-btn" id="exportJPG">
              <span>â¬‡ï¸</span>
              <span>å¯¼å‡ºJPG</span>
            </button>
          </div>
        </div>

        <!-- ä¸­é—´ç”»å¸ƒ -->
        <div class="canvas-area">
          <div class="canvas-controls">
            <button class="canvas-control-btn" id="undoBtn" title="æ’¤é”€">â†¶</button>
            <button class="canvas-control-btn" id="redoBtn" title="é‡åš">â†·</button>
            <button class="canvas-control-btn" id="previewBtn" title="é¢„è§ˆ">ğŸ‘ï¸</button>
          </div>
          <!-- ç§»åŠ¨ç«¯æ‚¬æµ®æŒ‰é’® -->
          <div class="mobile-fab">
            <button class="fab-btn" id="mobileFabTools" title="å·¥å…·">ğŸ› ï¸</button>
            <button class="fab-btn" id="mobileFabProps" title="å±æ€§">âš™ï¸</button>
          </div>
          <div class="canvas-wrapper" id="canvasWrapper">
            <canvas id="posterCanvas" width="1080" height="1920"></canvas>
          </div>
        </div>

        <!-- å³ä¾§å±æ€§é¢æ¿ -->
        <div class="properties-panel">
          <div class="property-group">
            <div class="tool-section-title">ğŸ“‹ å›¾å±‚åˆ—è¡¨</div>
            <div class="layer-list" id="layerList">
              <div class="empty-state">æš‚æ— å›¾å±‚<br/>æ·»åŠ å…ƒç´ å¼€å§‹è®¾è®¡</div>
            </div>
          </div>

          <div class="property-group" id="elementProps" style="display: none;">
            <div class="tool-section-title">âœï¸ å…ƒç´ å±æ€§</div>

            <div id="textProps" style="display: none;">
              <div class="property-group">
                <label class="property-label">æ–‡æœ¬å†…å®¹</label>
                <input type="text" class="property-input" id="textContent" placeholder="è¾“å…¥æ–‡æœ¬" />
              </div>

              <div class="property-row">
                <div>
                  <label class="property-label">å­—ä½“å¤§å°</label>
                  <input type="number" class="property-input font-size-input" id="fontSize" value="40" min="12" max="200" />
                </div>
                <div>
                  <label class="property-label">å­—ä½“ç²—ç»†</label>
                  <select class="property-input" id="fontWeight">
                    <option value="normal">æ­£å¸¸</option>
                    <option value="bold">ç²—ä½“</option>
                  </select>
                </div>
              </div>

              <div class="property-group">
                <label class="property-label">æ–‡æœ¬é¢œè‰²</label>
                <div class="color-picker-wrapper">
                  <input type="color" class="color-picker" id="textColor" value="#000000" />
                  <input type="text" class="property-input" id="textColorHex" value="#000000" />
                </div>
              </div>
            </div>

            <div id="shapeProps" style="display: none;">
              <div class="property-group">
                <label class="property-label">å¡«å……é¢œè‰²</label>
                <div class="color-picker-wrapper">
                  <input type="color" class="color-picker" id="fillColor" value="#ee6c4d" />
                  <input type="text" class="property-input" id="fillColorHex" value="#ee6c4d" />
                </div>
              </div>

              <div class="property-group">
                <label class="property-label">è¾¹æ¡†å®½åº¦</label>
                <input type="number" class="property-input" id="strokeWidth" value="0" min="0" max="20" />
              </div>

              <div class="property-group">
                <label class="property-label">è¾¹æ¡†é¢œè‰²</label>
                <div class="color-picker-wrapper">
                  <input type="color" class="color-picker" id="strokeColor" value="#000000" />
                  <input type="text" class="property-input" id="strokeColorHex" value="#000000" />
                </div>
              </div>
            </div>

            <div class="property-group">
              <label class="property-label">ä¸é€æ˜åº¦</label>
              <input type="range" class="property-input" id="opacity" min="0" max="100" value="100" />
            </div>

            <div class="property-row">
              <div>
                <label class="property-label">å®½åº¦</label>
                <input type="number" class="property-input" id="elementWidth" min="10" />
              </div>
              <div>
                <label class="property-label">é«˜åº¦</label>
                <input type="number" class="property-input" id="elementHeight" min="10" />
              </div>
            </div>

            <div class="property-row">
              <div>
                <label class="property-label">X ä½ç½®</label>
                <input type="number" class="property-input" id="elementX" />
              </div>
              <div>
                <label class="property-label">Y ä½ç½®</label>
                <input type="number" class="property-input" id="elementY" />
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- é¢„è§ˆæ¨¡æ€æ¡† -->
    <div class="preview-modal" id="previewModal">
      <div class="preview-content">
        <button class="preview-close" id="previewClose">Ã—</button>
        <canvas class="preview-canvas" id="previewCanvas"></canvas>
      </div>
    </div>

    <!-- é®ç½©å±‚ -->
    <div class="drawer-overlay" id="drawerOverlay"></div>

    <!-- å·¦ä¾§æŠ½å±‰ - å·¥å…·æ  -->
    <div class="drawer" id="toolDrawer">
      <div class="drawer-header">
        <div class="drawer-title">ğŸ› ï¸ å·¥å…·ç®±</div>
        <button class="drawer-close" id="closeToolDrawer">Ã—</button>
      </div>
      <!-- å·¥å…·æ å†…å®¹ï¼ˆå¤åˆ¶è‡ªtoolbarï¼‰ -->
      <div class="tool-section">
        <div class="tool-section-title">ğŸ“ ç”»å¸ƒå°ºå¯¸</div>
        <div class="preset-grid">
          <div class="preset-btn mobile-preset" data-size="800,600">800Ã—600</div>
          <div class="preset-btn mobile-preset active" data-size="1080,1920">1080Ã—1920<br/><small>ç«–å±</small></div>
          <div class="preset-btn mobile-preset" data-size="1920,1080">1920Ã—1080<br/><small>æ¨ªå±</small></div>
          <div class="preset-btn mobile-preset" data-size="1080,1080">1080Ã—1080<br/><small>æ–¹å½¢</small></div>
        </div>
      </div>

      <div class="tool-section">
        <div class="tool-section-title">ğŸ¨ èƒŒæ™¯è®¾ç½®</div>
        <button class="tool-btn mobile-tool" id="mobileBgColor">
          <span>ğŸ¨</span>
          <span>çº¯è‰²èƒŒæ™¯</span>
        </button>
        <button class="tool-btn mobile-tool" id="mobileUploadBg">
          <span>ğŸ–¼ï¸</span>
          <span>å›¾ç‰‡èƒŒæ™¯</span>
        </button>
      </div>

      <div class="tool-section">
        <div class="tool-section-title">â• æ·»åŠ å…ƒç´ </div>
        <button class="tool-btn mobile-tool" id="mobileAddText">
          <span>ğŸ“</span>
          <span>æ·»åŠ æ–‡æœ¬</span>
        </button>
        <button class="tool-btn mobile-tool" id="mobileUploadImage">
          <span>ğŸ–¼ï¸</span>
          <span>ä¸Šä¼ å›¾ç‰‡</span>
        </button>
        <button class="tool-btn mobile-tool" id="mobileAddRect">
          <span>â¬œ</span>
          <span>æ·»åŠ çŸ©å½¢</span>
        </button>
        <button class="tool-btn mobile-tool" id="mobileAddCircle">
          <span>â­•</span>
          <span>æ·»åŠ åœ†å½¢</span>
        </button>
      </div>

      <div class="tool-section">
        <div class="tool-section-title">ğŸ’¾ æ–‡ä»¶æ“ä½œ</div>
        <button class="tool-btn secondary mobile-tool" id="mobileClear">
          <span>ğŸ—‘ï¸</span>
          <span>æ¸…ç©ºç”»å¸ƒ</span>
        </button>
        <button class="tool-btn mobile-tool" id="mobileExportPNG">
          <span>â¬‡ï¸</span>
          <span>å¯¼å‡ºPNG</span>
        </button>
        <button class="tool-btn mobile-tool" id="mobileExportJPG">
          <span>â¬‡ï¸</span>
          <span>å¯¼å‡ºJPG</span>
        </button>
      </div>
    </div>

    <!-- å³ä¾§æŠ½å±‰ - å±æ€§é¢æ¿ -->
    <div class="drawer" id="propsDrawer">
      <div class="drawer-header">
        <div class="drawer-title">âš™ï¸ å±æ€§é¢æ¿</div>
        <button class="drawer-close" id="closePropsDrawer">Ã—</button>
      </div>
      <!-- å±æ€§é¢æ¿å†…å®¹ï¼ˆå¤åˆ¶è‡ªproperties-panelï¼‰ -->
      <div class="property-group">
        <div class="tool-section-title">ğŸ“‹ å›¾å±‚åˆ—è¡¨</div>
        <div class="layer-list" id="mobileLayerList">
          <div class="empty-state">æš‚æ— å›¾å±‚<br/>æ·»åŠ å…ƒç´ å¼€å§‹è®¾è®¡</div>
        </div>
      </div>

      <div class="property-group" id="mobileElementProps" style="display: none;">
        <div class="tool-section-title">âœï¸ å…ƒç´ å±æ€§</div>

        <div id="mobileTextProps" style="display: none;">
          <div class="property-group">
            <label class="property-label">æ–‡æœ¬å†…å®¹</label>
            <input type="text" class="property-input" id="mobileTextContent" placeholder="è¾“å…¥æ–‡æœ¬" />
          </div>

          <div class="property-row">
            <div>
              <label class="property-label">å­—ä½“å¤§å°</label>
              <input type="number" class="property-input font-size-input" id="mobileFontSize" value="40" min="12" max="200" />
            </div>
            <div>
              <label class="property-label">å­—ä½“ç²—ç»†</label>
              <select class="property-input" id="mobileFontWeight">
                <option value="normal">æ­£å¸¸</option>
                <option value="bold">ç²—ä½“</option>
              </select>
            </div>
          </div>

          <div class="property-group">
            <label class="property-label">æ–‡æœ¬é¢œè‰²</label>
            <div class="color-picker-wrapper">
              <input type="color" class="color-picker" id="mobileTextColor" value="#000000" />
              <input type="text" class="property-input" id="mobileTextColorHex" value="#000000" />
            </div>
          </div>
        </div>

        <div id="mobileShapeProps" style="display: none;">
          <div class="property-group">
            <label class="property-label">å¡«å……é¢œè‰²</label>
            <div class="color-picker-wrapper">
              <input type="color" class="color-picker" id="mobileFillColor" value="#ee6c4d" />
              <input type="text" class="property-input" id="mobileFillColorHex" value="#ee6c4d" />
            </div>
          </div>

          <div class="property-group">
            <label class="property-label">è¾¹æ¡†é¢œè‰²</label>
            <div class="color-picker-wrapper">
              <input type="color" class="color-picker" id="mobileStrokeColor" value="#000000" />
              <input type="text" class="property-input" id="mobileStrokeColorHex" value="#000000" />
            </div>
          </div>

          <div class="property-group">
            <label class="property-label">è¾¹æ¡†å®½åº¦</label>
            <input type="number" class="property-input" id="mobileStrokeWidth" value="0" min="0" max="20" />
          </div>
        </div>

        <div class="property-row">
          <div>
            <label class="property-label">å®½åº¦</label>
            <input type="number" class="property-input" id="mobileElementWidth" min="10" />
          </div>
          <div>
            <label class="property-label">é«˜åº¦</label>
            <input type="number" class="property-input" id="mobileElementHeight" min="10" />
          </div>
        </div>

        <div class="property-row">
          <div>
            <label class="property-label">X ä½ç½®</label>
            <input type="number" class="property-input" id="mobileElementX" />
          </div>
          <div>
            <label class="property-label">Y ä½ç½®</label>
            <input type="number" class="property-input" id="mobileElementY" />
          </div>
        </div>

        <div class="property-group">
          <button class="tool-btn secondary" id="mobileDeleteElement" style="width: 100%;">
            <span>ğŸ—‘ï¸</span>
            <span>åˆ é™¤å…ƒç´ </span>
          </button>
        </div>
      </div>
    </div>

    <script src="../../shared/scripts/common.js"></script>
    <script src="../../shared/scripts/theme.js"></script>
    <script>
      // Canvas å’Œä¸Šä¸‹æ–‡
      const canvas = document.getElementById('posterCanvas');
      const ctx = canvas.getContext('2d');

      // å…ƒç´ æ•°ç»„å’Œé€‰ä¸­çŠ¶æ€
      let elements = [];
      let selectedElement = null;
      let isDragging = false;
      let isResizing = false;
      let dragStartX = 0;
      let dragStartY = 0;
      let resizeHandle = null;

      // å†å²è®°å½•ï¼ˆç”¨äºæ’¤é”€/é‡åšï¼‰
      let history = [];
      let historyIndex = -1;
      const MAX_HISTORY = 50;

      // èƒŒæ™¯è®¾ç½®
      let backgroundColor = '#ffffff';
      let backgroundImage = null;

      // å…ƒç´ ç±»å‹å®šä¹‰
      class Element {
        constructor(type, x, y, width, height) {
          this.id = Date.now() + Math.random();
          this.type = type;
          this.x = x;
          this.y = y;
          this.width = width;
          this.height = height;
          this.opacity = 1;
          this.rotation = 0;
        }

        draw(ctx) {
          ctx.save();
          ctx.globalAlpha = this.opacity;
          ctx.translate(this.x + this.width / 2, this.y + this.height / 2);
          ctx.rotate(this.rotation * Math.PI / 180);
          ctx.translate(-(this.x + this.width / 2), -(this.y + this.height / 2));

          this.drawContent(ctx);

          ctx.restore();

          // ç»˜åˆ¶é€‰ä¸­æ¡†
          if (this === selectedElement) {
            this.drawSelectionBox(ctx);
          }
        }

        drawContent(ctx) {
          // ç”±å­ç±»å®ç°
        }

        drawSelectionBox(ctx) {
          ctx.strokeStyle = '#ee6c4d';
          ctx.lineWidth = 2;
          ctx.setLineDash([5, 5]);
          ctx.strokeRect(this.x, this.y, this.width, this.height);
          ctx.setLineDash([]);

          // ç»˜åˆ¶è°ƒæ•´æ‰‹æŸ„
          const handles = this.getResizeHandles();
          ctx.fillStyle = '#ee6c4d';
          handles.forEach(handle => {
            ctx.fillRect(handle.x - 4, handle.y - 4, 8, 8);
          });
        }

        getResizeHandles() {
          return [
            { x: this.x, y: this.y, cursor: 'nw-resize', handle: 'nw' },
            { x: this.x + this.width, y: this.y, cursor: 'ne-resize', handle: 'ne' },
            { x: this.x, y: this.y + this.height, cursor: 'sw-resize', handle: 'sw' },
            { x: this.x + this.width, y: this.y + this.height, cursor: 'se-resize', handle: 'se' }
          ];
        }

        contains(x, y) {
          return x >= this.x && x <= this.x + this.width &&
                 y >= this.y && y <= this.y + this.height;
        }

        getResizeHandleAt(x, y) {
          const handles = this.getResizeHandles();
          for (let handle of handles) {
            const distance = Math.sqrt(Math.pow(x - handle.x, 2) + Math.pow(y - handle.y, 2));
            if (distance < 10) {
              return handle;
            }
          }
          return null;
        }
      }

      class TextElement extends Element {
        constructor(x, y, text = 'åŒå‡»ç¼–è¾‘æ–‡æœ¬') {
          super('text', x, y, 200, 50);
          this.text = text;
          this.fontSize = 40;
          this.fontWeight = 'normal';
          this.color = '#000000';
          this.fontFamily = 'Arial, sans-serif';
        }

        drawContent(ctx) {
          ctx.font = `${this.fontWeight} ${this.fontSize}px ${this.fontFamily}`;
          ctx.fillStyle = this.color;
          ctx.textBaseline = 'top';

          // è‡ªåŠ¨è°ƒæ•´å®½åº¦ä»¥é€‚åº”æ–‡æœ¬
          const metrics = ctx.measureText(this.text);
          this.width = Math.max(metrics.width + 20, 100);
          this.height = this.fontSize + 10;

          ctx.fillText(this.text, this.x, this.y);
        }
      }

      class ImageElement extends Element {
        constructor(x, y, image) {
          super('image', x, y, image.width, image.height);
          this.image = image;

          // é™åˆ¶å›¾ç‰‡å¤§å°
          const maxSize = 500;
          if (this.width > maxSize || this.height > maxSize) {
            const ratio = Math.min(maxSize / this.width, maxSize / this.height);
            this.width *= ratio;
            this.height *= ratio;
          }
        }

        drawContent(ctx) {
          ctx.drawImage(this.image, this.x, this.y, this.width, this.height);
        }
      }

      class RectElement extends Element {
        constructor(x, y) {
          super('rect', x, y, 200, 150);
          this.fillColor = '#ee6c4d';
          this.strokeWidth = 0;
          this.strokeColor = '#000000';
        }

        drawContent(ctx) {
          ctx.fillStyle = this.fillColor;
          ctx.fillRect(this.x, this.y, this.width, this.height);

          if (this.strokeWidth > 0) {
            ctx.strokeStyle = this.strokeColor;
            ctx.lineWidth = this.strokeWidth;
            ctx.strokeRect(this.x, this.y, this.width, this.height);
          }
        }
      }

      class CircleElement extends Element {
        constructor(x, y) {
          super('circle', x, y, 150, 150);
          this.fillColor = '#f4a261';
          this.strokeWidth = 0;
          this.strokeColor = '#000000';
        }

        drawContent(ctx) {
          const centerX = this.x + this.width / 2;
          const centerY = this.y + this.height / 2;
          const radiusX = this.width / 2;
          const radiusY = this.height / 2;

          ctx.beginPath();
          ctx.ellipse(centerX, centerY, radiusX, radiusY, 0, 0, Math.PI * 2);
          ctx.fillStyle = this.fillColor;
          ctx.fill();

          if (this.strokeWidth > 0) {
            ctx.strokeStyle = this.strokeColor;
            ctx.lineWidth = this.strokeWidth;
            ctx.stroke();
          }
        }
      }

      // åˆå§‹åŒ–
      function init() {
        adjustCanvasSize();
        render();
        updateLayerList();
        bindEvents();

        // çª—å£å¤§å°å˜åŒ–æ—¶è°ƒæ•´ç”»å¸ƒæ˜¾ç¤º
        window.addEventListener('resize', adjustCanvasSize);
      }

      // è°ƒæ•´ç”»å¸ƒæ˜¾ç¤ºå¤§å°ï¼ˆä¿æŒå®é™…åˆ†è¾¨ç‡ä¸å˜ï¼‰
      function adjustCanvasSize() {
        const wrapper = document.getElementById('canvasWrapper');
        const maxWidth = wrapper.parentElement.clientWidth - 60;
        const maxHeight = window.innerHeight - 280;

        // è®¡ç®—ç¼©æ”¾æ¯”ä¾‹
        const scaleX = maxWidth / canvas.width;
        const scaleY = maxHeight / canvas.height;
        const scale = Math.min(scaleX, scaleY, 1); // æœ€å¤§ä¸è¶…è¿‡1ï¼ˆä¸æ”¾å¤§ï¼‰

        // è®¾ç½®æ˜¾ç¤ºå°ºå¯¸
        if (scale < 1) {
          canvas.style.width = (canvas.width * scale) + 'px';
          canvas.style.height = (canvas.height * scale) + 'px';
        } else {
          canvas.style.width = canvas.width + 'px';
          canvas.style.height = canvas.height + 'px';
        }
      }

      // æ¸²æŸ“ç”»å¸ƒ
      function render() {
        // æ¸…ç©ºç”»å¸ƒ
        ctx.clearRect(0, 0, canvas.width, canvas.height);

        // ç»˜åˆ¶èƒŒæ™¯
        if (backgroundImage) {
          ctx.drawImage(backgroundImage, 0, 0, canvas.width, canvas.height);
        } else {
          ctx.fillStyle = backgroundColor;
          ctx.fillRect(0, 0, canvas.width, canvas.height);
        }

        // ç»˜åˆ¶æ‰€æœ‰å…ƒç´ 
        elements.forEach(element => {
          element.draw(ctx);
        });
      }

      // æ·»åŠ æ–‡æœ¬
      document.getElementById('addText').addEventListener('click', () => {
        const text = new TextElement(canvas.width / 2 - 100, canvas.height / 2 - 25);
        elements.push(text);
        selectElement(text);
        saveHistory();
        render();
        updateLayerList();
        showToast('å·²æ·»åŠ æ–‡æœ¬å…ƒç´ ', 'success');
      });

      // ä¸Šä¼ å›¾ç‰‡
      document.getElementById('uploadImage').addEventListener('click', () => {
        document.getElementById('imageInput').click();
      });

      document.getElementById('imageInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              const imageElement = new ImageElement(50, 50, img);
              elements.push(imageElement);
              selectElement(imageElement);
              saveHistory();
              render();
              updateLayerList();
              showToast('å·²æ·»åŠ å›¾ç‰‡', 'success');
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
        e.target.value = '';
      });

      // æ·»åŠ çŸ©å½¢
      document.getElementById('addRect').addEventListener('click', () => {
        const rect = new RectElement(canvas.width / 2 - 100, canvas.height / 2 - 75);
        elements.push(rect);
        selectElement(rect);
        saveHistory();
        render();
        updateLayerList();
        showToast('å·²æ·»åŠ çŸ©å½¢', 'success');
      });

      // æ·»åŠ åœ†å½¢
      document.getElementById('addCircle').addEventListener('click', () => {
        const circle = new CircleElement(canvas.width / 2 - 75, canvas.height / 2 - 75);
        elements.push(circle);
        selectElement(circle);
        saveHistory();
        render();
        updateLayerList();
        showToast('å·²æ·»åŠ åœ†å½¢', 'success');
      });

      // è®¾ç½®èƒŒæ™¯é¢œè‰²
      document.getElementById('setBgColor').addEventListener('click', () => {
        const color = prompt('è¯·è¾“å…¥èƒŒæ™¯é¢œè‰² (å¦‚: #ffffff æˆ– white):', backgroundColor);
        if (color) {
          backgroundColor = color;
          backgroundImage = null;
          saveHistory();
          render();
          showToast('èƒŒæ™¯é¢œè‰²å·²æ›´æ–°', 'success');
        }
      });

      // ä¸Šä¼ èƒŒæ™¯å›¾ç‰‡
      document.getElementById('uploadBgImage').addEventListener('click', () => {
        document.getElementById('bgImageInput').click();
      });

      document.getElementById('bgImageInput').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const reader = new FileReader();
          reader.onload = (event) => {
            const img = new Image();
            img.onload = () => {
              backgroundImage = img;
              saveHistory();
              render();
              showToast('èƒŒæ™¯å›¾ç‰‡å·²è®¾ç½®', 'success');
            };
            img.src = event.target.result;
          };
          reader.readAsDataURL(file);
        }
        e.target.value = '';
      });

      // æ¸…ç©ºç”»å¸ƒ
      document.getElementById('clearCanvas').addEventListener('click', () => {
        if (confirm('ç¡®å®šè¦æ¸…ç©ºç”»å¸ƒå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚')) {
          elements = [];
          selectedElement = null;
          backgroundColor = '#ffffff';
          backgroundImage = null;
          history = [];
          historyIndex = -1;
          render();
          updateLayerList();
          updateProperties();
          showToast('ç”»å¸ƒå·²æ¸…ç©º', 'success');
        }
      });

      // å¯¼å‡ºPNG
      document.getElementById('exportPNG').addEventListener('click', () => {
        exportImage('png');
      });

      // å¯¼å‡ºJPG
      document.getElementById('exportJPG').addEventListener('click', () => {
        exportImage('jpeg');
      });

      function exportImage(format) {
        // ä¸´æ—¶å–æ¶ˆé€‰ä¸­çŠ¶æ€
        const tempSelected = selectedElement;
        selectedElement = null;
        render();

        // å¯¼å‡º
        canvas.toBlob((blob) => {
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `poster_${Date.now()}.${format === 'jpeg' ? 'jpg' : 'png'}`;
          a.click();
          URL.revokeObjectURL(url);

          // æ¢å¤é€‰ä¸­çŠ¶æ€
          selectedElement = tempSelected;
          render();

          showToast(`å·²å¯¼å‡º${format.toUpperCase()}å›¾ç‰‡`, 'success');
        }, `image/${format}`, 0.95);
      }

      // ç”»å¸ƒå°ºå¯¸é¢„è®¾
      document.querySelectorAll('.preset-btn').forEach(btn => {
        btn.addEventListener('click', function() {
          const [width, height] = this.dataset.size.split(',').map(Number);
          canvas.width = width;
          canvas.height = height;

          document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
          this.classList.add('active');

          adjustCanvasSize();
          render();
          showToast(`ç”»å¸ƒå°ºå¯¸å·²è°ƒæ•´ä¸º ${width}Ã—${height}`, 'success');
        });
      });

      // é€‰ä¸­å…ƒç´ 
      function selectElement(element) {
        selectedElement = element;
        updateProperties();
        updateLayerList();
        render();
      }

      // æ›´æ–°å±æ€§é¢æ¿
      function updateProperties() {
        const propsPanel = document.getElementById('elementProps');
        const textProps = document.getElementById('textProps');
        const shapeProps = document.getElementById('shapeProps');

        // ç§»åŠ¨ç«¯é¢æ¿
        const mobilePropsPanel = document.getElementById('mobileElementProps');
        const mobileTextProps = document.getElementById('mobileTextProps');
        const mobileShapeProps = document.getElementById('mobileShapeProps');

        if (!selectedElement) {
          propsPanel.style.display = 'none';
          mobilePropsPanel.style.display = 'none';
          return;
        }

        propsPanel.style.display = 'block';
        mobilePropsPanel.style.display = 'block';

        // é€šç”¨å±æ€§ - æ¡Œé¢ç«¯
        document.getElementById('opacity').value = selectedElement.opacity * 100;
        document.getElementById('elementWidth').value = Math.round(selectedElement.width);
        document.getElementById('elementHeight').value = Math.round(selectedElement.height);
        document.getElementById('elementX').value = Math.round(selectedElement.x);
        document.getElementById('elementY').value = Math.round(selectedElement.y);

        // é€šç”¨å±æ€§ - ç§»åŠ¨ç«¯
        document.getElementById('mobileElementWidth').value = Math.round(selectedElement.width);
        document.getElementById('mobileElementHeight').value = Math.round(selectedElement.height);
        document.getElementById('mobileElementX').value = Math.round(selectedElement.x);
        document.getElementById('mobileElementY').value = Math.round(selectedElement.y);

        // æ–‡æœ¬å±æ€§
        if (selectedElement.type === 'text') {
          textProps.style.display = 'block';
          shapeProps.style.display = 'none';
          mobileTextProps.style.display = 'block';
          mobileShapeProps.style.display = 'none';

          // æ¡Œé¢ç«¯
          document.getElementById('textContent').value = selectedElement.text;
          document.getElementById('fontSize').value = selectedElement.fontSize;
          document.getElementById('fontWeight').value = selectedElement.fontWeight;
          document.getElementById('textColor').value = selectedElement.color;
          document.getElementById('textColorHex').value = selectedElement.color;

          // ç§»åŠ¨ç«¯
          document.getElementById('mobileTextContent').value = selectedElement.text;
          document.getElementById('mobileFontSize').value = selectedElement.fontSize;
          document.getElementById('mobileFontWeight').value = selectedElement.fontWeight;
          document.getElementById('mobileTextColor').value = selectedElement.color;
          document.getElementById('mobileTextColorHex').value = selectedElement.color;
        } else {
          textProps.style.display = 'none';
          mobileTextProps.style.display = 'none';
        }

        // å½¢çŠ¶å±æ€§
        if (selectedElement.type === 'rect' || selectedElement.type === 'circle') {
          shapeProps.style.display = 'block';
          mobileShapeProps.style.display = 'block';

          // æ¡Œé¢ç«¯
          document.getElementById('fillColor').value = selectedElement.fillColor;
          document.getElementById('fillColorHex').value = selectedElement.fillColor;
          document.getElementById('strokeWidth').value = selectedElement.strokeWidth;
          document.getElementById('strokeColor').value = selectedElement.strokeColor;
          document.getElementById('strokeColorHex').value = selectedElement.strokeColor;

          // ç§»åŠ¨ç«¯
          document.getElementById('mobileFillColor').value = selectedElement.fillColor;
          document.getElementById('mobileFillColorHex').value = selectedElement.fillColor;
          document.getElementById('mobileStrokeWidth').value = selectedElement.strokeWidth;
          document.getElementById('mobileStrokeColor').value = selectedElement.strokeColor;
          document.getElementById('mobileStrokeColorHex').value = selectedElement.strokeColor;
        } else {
          shapeProps.style.display = 'none';
          mobileShapeProps.style.display = 'none';
        }
      }

      // æ›´æ–°å›¾å±‚åˆ—è¡¨
      function updateLayerList() {
        const layerList = document.getElementById('layerList');
        const mobileLayerList = document.getElementById('mobileLayerList');

        function renderLayerList(container) {
          if (elements.length === 0) {
            container.innerHTML = '<div class="empty-state">æš‚æ— å›¾å±‚<br/>æ·»åŠ å…ƒç´ å¼€å§‹è®¾è®¡</div>';
            return;
          }

          container.innerHTML = '';

          // åå‘æ˜¾ç¤ºï¼ˆæœ€ä¸Šå±‚åœ¨æœ€å‰ï¼‰
          [...elements].reverse().forEach((element, index) => {
            const actualIndex = elements.length - 1 - index;
            const layerItem = document.createElement('div');
            layerItem.className = 'layer-item';
            if (element === selectedElement) {
              layerItem.classList.add('active');
            }

            let icon = 'ğŸ“„';
            let name = 'å…ƒç´ ';
            if (element.type === 'text') {
              icon = 'ğŸ“';
              name = element.text.substring(0, 10);
            } else if (element.type === 'image') {
              icon = 'ğŸ–¼ï¸';
              name = 'å›¾ç‰‡';
            } else if (element.type === 'rect') {
              icon = 'â¬œ';
              name = 'çŸ©å½¢';
            } else if (element.type === 'circle') {
              icon = 'â­•';
              name = 'åœ†å½¢';
            }

            layerItem.innerHTML = `
              <span>${icon} ${name}</span>
              <div class="layer-actions">
                <button class="layer-action-btn move-up" data-index="${actualIndex}" title="ä¸Šç§»">â†‘</button>
                <button class="layer-action-btn move-down" data-index="${actualIndex}" title="ä¸‹ç§»">â†“</button>
                <button class="layer-action-btn delete-layer" data-index="${actualIndex}" title="åˆ é™¤">ğŸ—‘ï¸</button>
              </div>
            `;

            // é€‰ä¸­å›¾å±‚äº‹ä»¶ï¼ˆåŒäº‹ä»¶ç»‘å®šï¼‰
            const selectHandler = (e) => {
              if (!e.target.classList.contains('layer-action-btn')) {
                selectElement(element);
              }
            };
            layerItem.addEventListener('click', selectHandler);
            layerItem.addEventListener('touchstart', selectHandler, { passive: false });

            // ç»‘å®šå›¾å±‚æ“ä½œæŒ‰é’®äº‹ä»¶
            const moveUpBtn = layerItem.querySelector('.move-up');
            const moveDownBtn = layerItem.querySelector('.move-down');
            const deleteBtn = layerItem.querySelector('.delete-layer');

            if (moveUpBtn) {
              const moveUpHandler = (e) => {
                e.preventDefault();
                e.stopPropagation();
                moveLayer(actualIndex, -1);
              };
              moveUpBtn.addEventListener('click', moveUpHandler);
              moveUpBtn.addEventListener('touchstart', moveUpHandler, { passive: false });
            }

            if (moveDownBtn) {
              const moveDownHandler = (e) => {
                e.preventDefault();
                e.stopPropagation();
                moveLayer(actualIndex, 1);
              };
              moveDownBtn.addEventListener('click', moveDownHandler);
              moveDownBtn.addEventListener('touchstart', moveDownHandler, { passive: false });
            }

            if (deleteBtn) {
              const deleteHandler = (e) => {
                e.preventDefault();
                e.stopPropagation();
                deleteLayer(actualIndex);
              };
              deleteBtn.addEventListener('click', deleteHandler);
              deleteBtn.addEventListener('touchstart', deleteHandler, { passive: false });
            }

            container.appendChild(layerItem);
          });
        }

        // åŒæ—¶æ›´æ–°æ¡Œé¢ç«¯å’Œç§»åŠ¨ç«¯
        renderLayerList(layerList);
        renderLayerList(mobileLayerList);
      }

      // ç§»åŠ¨å›¾å±‚
      window.moveLayer = function(index, direction) {
        const newIndex = index + direction;
        if (newIndex < 0 || newIndex >= elements.length) return;

        [elements[index], elements[newIndex]] = [elements[newIndex], elements[index]];
        saveHistory();
        render();
        updateLayerList();
      };

      // åˆ é™¤å›¾å±‚
      window.deleteLayer = function(index) {
        if (confirm('ç¡®å®šè¦åˆ é™¤æ­¤å›¾å±‚å—ï¼Ÿ')) {
          if (elements[index] === selectedElement) {
            selectedElement = null;
            updateProperties();
          }
          elements.splice(index, 1);
          saveHistory();
          render();
          updateLayerList();
          showToast('å›¾å±‚å·²åˆ é™¤', 'success');
        }
      };

      // ç»‘å®šäº‹ä»¶
      function bindEvents() {
        // é¼ æ ‡äº‹ä»¶ - ç»‘å®šåˆ°windowä»¥æ”¯æŒæ‹–æ‹½åˆ°ç”»å¸ƒå¤–
        canvas.addEventListener('mousedown', handleMouseDown);
        window.addEventListener('mousemove', handleMouseMove);
        window.addEventListener('mouseup', handleMouseUp);
        canvas.addEventListener('mouseleave', handleMouseLeave);
        canvas.addEventListener('dblclick', handleDoubleClick);

        // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
        canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
        window.addEventListener('touchmove', handleTouchMove, { passive: false });
        window.addEventListener('touchend', handleTouchEnd);

        // å±æ€§æ›´æ–°äº‹ä»¶
        bindPropertyEvents();

        // æ’¤é”€/é‡åš
        const undoHandler = (e) => {
          e.preventDefault();
          e.stopPropagation();
          undo();
        };
        document.getElementById('undoBtn').addEventListener('click', undoHandler);
        document.getElementById('undoBtn').addEventListener('touchstart', undoHandler, { passive: false });

        const redoHandler = (e) => {
          e.preventDefault();
          e.stopPropagation();
          redo();
        };
        document.getElementById('redoBtn').addEventListener('click', redoHandler);
        document.getElementById('redoBtn').addEventListener('touchstart', redoHandler, { passive: false });

        // é¢„è§ˆ
        const previewHandler = (e) => {
          e.preventDefault();
          e.stopPropagation();
          openPreview();
        };
        document.getElementById('previewBtn').addEventListener('click', previewHandler);
        document.getElementById('previewBtn').addEventListener('touchstart', previewHandler, { passive: false });

        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Delete' && selectedElement) {
            const index = elements.indexOf(selectedElement);
            if (index !== -1) {
              deleteLayer(index);
            }
          }
          if (e.ctrlKey && e.key === 'z') {
            e.preventDefault();
            undo();
          }
          if (e.ctrlKey && e.key === 'y') {
            e.preventDefault();
            redo();
          }
        });
      }

      // å°†å±å¹•åæ ‡è½¬æ¢ä¸ºç”»å¸ƒåæ ‡
      function getCanvasCoordinates(e) {
        const rect = canvas.getBoundingClientRect();
        const scaleX = canvas.width / rect.width;
        const scaleY = canvas.height / rect.height;

        return {
          x: (e.clientX - rect.left) * scaleX,
          y: (e.clientY - rect.top) * scaleY
        };
      }

      function handleMouseDown(e) {
        const { x, y } = getCanvasCoordinates(e);

        // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†è°ƒæ•´æ‰‹æŸ„
        if (selectedElement) {
          const handle = selectedElement.getResizeHandleAt(x, y);
          if (handle) {
            isResizing = true;
            resizeHandle = handle;
            canvas.classList.add('resizing');
            return;
          }
        }

        // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»äº†å…ƒç´ ï¼ˆä»ä¸Šåˆ°ä¸‹æ£€æŸ¥ï¼‰
        for (let i = elements.length - 1; i >= 0; i--) {
          if (elements[i].contains(x, y)) {
            selectElement(elements[i]);
            isDragging = true;
            dragStartX = x - selectedElement.x;
            dragStartY = y - selectedElement.y;
            canvas.classList.add('dragging');
            return;
          }
        }

        // ç‚¹å‡»ç©ºç™½å¤„å–æ¶ˆé€‰ä¸­
        selectedElement = null;
        updateProperties();
        updateLayerList();
        render();
      }

      function handleMouseMove(e) {
        // å¦‚æœæ­£åœ¨æ‹–æ‹½æˆ–è°ƒæ•´å¤§å°ï¼Œå³ä½¿é¼ æ ‡ç¦»å¼€ç”»å¸ƒä¹Ÿè¦å¤„ç†
        if (isDragging || isResizing) {
          const { x, y } = getCanvasCoordinates(e);

          if (isResizing && selectedElement && resizeHandle) {
            // è°ƒæ•´å¤§å°
            const handle = resizeHandle.handle;
            if (handle === 'se') {
              selectedElement.width = Math.max(20, x - selectedElement.x);
              selectedElement.height = Math.max(20, y - selectedElement.y);
            } else if (handle === 'sw') {
              const newWidth = Math.max(20, selectedElement.x + selectedElement.width - x);
              selectedElement.x = x;
              selectedElement.width = newWidth;
              selectedElement.height = Math.max(20, y - selectedElement.y);
            } else if (handle === 'ne') {
              selectedElement.width = Math.max(20, x - selectedElement.x);
              const newHeight = Math.max(20, selectedElement.y + selectedElement.height - y);
              selectedElement.y = y;
              selectedElement.height = newHeight;
            } else if (handle === 'nw') {
              const newWidth = Math.max(20, selectedElement.x + selectedElement.width - x);
              const newHeight = Math.max(20, selectedElement.y + selectedElement.height - y);
              selectedElement.x = x;
              selectedElement.y = y;
              selectedElement.width = newWidth;
              selectedElement.height = newHeight;
            }
            updateProperties();
            render();
          } else if (isDragging && selectedElement) {
            // æ‹–åŠ¨ - å…è®¸æ‹–åŠ¨åˆ°ç”»å¸ƒå¤–ä½†é™åˆ¶åœ¨è¾¹ç•Œ
            selectedElement.x = Math.max(0, Math.min(canvas.width - selectedElement.width, x - dragStartX));
            selectedElement.y = Math.max(0, Math.min(canvas.height - selectedElement.height, y - dragStartY));
            updateProperties();
            render();
          }
        } else {
          // ä»…åœ¨ç”»å¸ƒå†…æ—¶æ›´æ–°é¼ æ ‡æ ·å¼
          const rect = canvas.getBoundingClientRect();
          if (e.clientX >= rect.left && e.clientX <= rect.right &&
              e.clientY >= rect.top && e.clientY <= rect.bottom) {
            const { x, y } = getCanvasCoordinates(e);

            if (selectedElement) {
              const handle = selectedElement.getResizeHandleAt(x, y);
              canvas.style.cursor = handle ? handle.cursor : (selectedElement.contains(x, y) ? 'move' : 'crosshair');
            } else {
              canvas.style.cursor = 'crosshair';
            }
          }
        }
      }

      function handleMouseUp(e) {
        if (isDragging || isResizing) {
          saveHistory();
        }
        isDragging = false;
        isResizing = false;
        resizeHandle = null;
        canvas.classList.remove('dragging', 'resizing');
        canvas.style.cursor = 'crosshair';
      }

      function handleMouseLeave(e) {
        // é¼ æ ‡ç¦»å¼€ç”»å¸ƒæ—¶ï¼Œå¦‚æœæ²¡æœ‰åœ¨æ‹–æ‹½ï¼Œé‡ç½®æ ·å¼
        if (!isDragging && !isResizing) {
          canvas.style.cursor = 'crosshair';
        }
      }

      // è§¦æ‘¸äº‹ä»¶æ”¯æŒ
      function handleTouchStart(e) {
        e.preventDefault();
        if (e.touches.length === 1) {
          const touch = e.touches[0];
          const mouseEvent = new MouseEvent('mousedown', {
            clientX: touch.clientX,
            clientY: touch.clientY
          });
          handleMouseDown(mouseEvent);
        }
      }

      function handleTouchMove(e) {
        e.preventDefault();
        if (e.touches.length === 1) {
          const touch = e.touches[0];
          const mouseEvent = new MouseEvent('mousemove', {
            clientX: touch.clientX,
            clientY: touch.clientY
          });
          handleMouseMove(mouseEvent);
        }
      }

      function handleTouchEnd(e) {
        e.preventDefault();
        const mouseEvent = new MouseEvent('mouseup', {});
        handleMouseUp(mouseEvent);
      }

      function handleDoubleClick(e) {
        if (selectedElement && selectedElement.type === 'text') {
          const newText = prompt('è¯·è¾“å…¥æ–‡æœ¬å†…å®¹:', selectedElement.text);
          if (newText !== null) {
            selectedElement.text = newText;
            document.getElementById('textContent').value = newText;
            saveHistory();
            render();
            updateLayerList();
          }
        }
      }

      // ç»‘å®šå±æ€§æ›´æ–°äº‹ä»¶
      function bindPropertyEvents() {
        // æ–‡æœ¬å†…å®¹
        document.getElementById('textContent').addEventListener('input', (e) => {
          if (selectedElement && selectedElement.type === 'text') {
            selectedElement.text = e.target.value;
            render();
            updateLayerList();
          }
        });

        // å­—ä½“å¤§å°
        document.getElementById('fontSize').addEventListener('input', (e) => {
          if (selectedElement && selectedElement.type === 'text') {
            selectedElement.fontSize = parseInt(e.target.value);
            render();
          }
        });

        // å­—ä½“ç²—ç»†
        document.getElementById('fontWeight').addEventListener('change', (e) => {
          if (selectedElement && selectedElement.type === 'text') {
            selectedElement.fontWeight = e.target.value;
            render();
          }
        });

        // æ–‡æœ¬é¢œè‰²
        document.getElementById('textColor').addEventListener('input', (e) => {
          if (selectedElement && selectedElement.type === 'text') {
            selectedElement.color = e.target.value;
            document.getElementById('textColorHex').value = e.target.value;
            render();
          }
        });

        document.getElementById('textColorHex').addEventListener('input', (e) => {
          if (selectedElement && selectedElement.type === 'text') {
            selectedElement.color = e.target.value;
            document.getElementById('textColor').value = e.target.value;
            render();
          }
        });

        // å¡«å……é¢œè‰²
        document.getElementById('fillColor').addEventListener('input', (e) => {
          if (selectedElement && (selectedElement.type === 'rect' || selectedElement.type === 'circle')) {
            selectedElement.fillColor = e.target.value;
            document.getElementById('fillColorHex').value = e.target.value;
            render();
          }
        });

        document.getElementById('fillColorHex').addEventListener('input', (e) => {
          if (selectedElement && (selectedElement.type === 'rect' || selectedElement.type === 'circle')) {
            selectedElement.fillColor = e.target.value;
            document.getElementById('fillColor').value = e.target.value;
            render();
          }
        });

        // è¾¹æ¡†
        document.getElementById('strokeWidth').addEventListener('input', (e) => {
          if (selectedElement && (selectedElement.type === 'rect' || selectedElement.type === 'circle')) {
            selectedElement.strokeWidth = parseInt(e.target.value);
            render();
          }
        });

        document.getElementById('strokeColor').addEventListener('input', (e) => {
          if (selectedElement && (selectedElement.type === 'rect' || selectedElement.type === 'circle')) {
            selectedElement.strokeColor = e.target.value;
            document.getElementById('strokeColorHex').value = e.target.value;
            render();
          }
        });

        document.getElementById('strokeColorHex').addEventListener('input', (e) => {
          if (selectedElement && (selectedElement.type === 'rect' || selectedElement.type === 'circle')) {
            selectedElement.strokeColor = e.target.value;
            document.getElementById('strokeColor').value = e.target.value;
            render();
          }
        });

        // ä¸é€æ˜åº¦
        document.getElementById('opacity').addEventListener('input', (e) => {
          if (selectedElement) {
            selectedElement.opacity = parseInt(e.target.value) / 100;
            render();
          }
        });

        // å°ºå¯¸å’Œä½ç½®
        ['elementWidth', 'elementHeight', 'elementX', 'elementY'].forEach(id => {
          document.getElementById(id).addEventListener('change', (e) => {
            if (!selectedElement) return;
            const value = parseInt(e.target.value);
            if (id === 'elementWidth') selectedElement.width = value;
            if (id === 'elementHeight') selectedElement.height = value;
            if (id === 'elementX') selectedElement.x = value;
            if (id === 'elementY') selectedElement.y = value;
            render();
          });
        });
      }

      // å†å²è®°å½•
      function saveHistory() {
        // ç§»é™¤å½“å‰ä½ç½®ä¹‹åçš„æ‰€æœ‰å†å²è®°å½•
        history = history.slice(0, historyIndex + 1);

        // ä¿å­˜å½“å‰çŠ¶æ€
        const state = {
          elements: JSON.parse(JSON.stringify(elements.map(e => ({
            ...e,
            imageData: e.type === 'image' ? e.image.src : null
          })))),
          backgroundColor,
          backgroundImageData: backgroundImage ? backgroundImage.src : null
        };

        history.push(state);
        historyIndex++;

        // é™åˆ¶å†å²è®°å½•æ•°é‡
        if (history.length > MAX_HISTORY) {
          history.shift();
          historyIndex--;
        }
      }

      function undo() {
        if (historyIndex > 0) {
          historyIndex--;
          restoreHistory();
          showToast('å·²æ’¤é”€', 'success');
        }
      }

      function redo() {
        if (historyIndex < history.length - 1) {
          historyIndex++;
          restoreHistory();
          showToast('å·²é‡åš', 'success');
        }
      }

      function restoreHistory() {
        const state = history[historyIndex];
        if (!state) return;

        // æ¢å¤å…ƒç´ ï¼ˆç®€åŒ–ç‰ˆï¼Œå®é™…éœ€è¦æ ¹æ®ç±»å‹é‡å»ºå¯¹è±¡ï¼‰
        elements = state.elements.map(e => {
          if (e.type === 'text') {
            const text = new TextElement(e.x, e.y, e.text);
            Object.assign(text, e);
            return text;
          } else if (e.type === 'rect') {
            const rect = new RectElement(e.x, e.y);
            Object.assign(rect, e);
            return rect;
          } else if (e.type === 'circle') {
            const circle = new CircleElement(e.x, e.y);
            Object.assign(circle, e);
            return circle;
          }
          return e;
        });

        backgroundColor = state.backgroundColor;

        // æ¢å¤èƒŒæ™¯å›¾ç‰‡
        if (state.backgroundImageData) {
          const img = new Image();
          img.onload = () => {
            backgroundImage = img;
            render();
          };
          img.src = state.backgroundImageData;
        } else {
          backgroundImage = null;
        }

        selectedElement = null;
        render();
        updateLayerList();
        updateProperties();
      }

      // æ˜¾ç¤ºæç¤ºä¿¡æ¯
      function showToast(message, type = 'success') {
        const toast = document.getElementById('toast');
        const icon = document.getElementById('toastIcon');
        const messageEl = document.getElementById('toastMessage');

        toast.className = 'toast show ' + type;
        icon.textContent = type === 'success' ? 'âœ…' : 'âŒ';
        messageEl.textContent = message;

        setTimeout(() => {
          toast.classList.remove('show');
        }, 3000);
      }

      // ========== é¢„è§ˆåŠŸèƒ½ ==========
      function openPreview() {
        const previewModal = document.getElementById('previewModal');
        const previewCanvas = document.getElementById('previewCanvas');
        const previewCtx = previewCanvas.getContext('2d');

        // è®¾ç½®é¢„è§ˆç”»å¸ƒå°ºå¯¸
        previewCanvas.width = canvas.width;
        previewCanvas.height = canvas.height;

        // å¤åˆ¶ä¸»ç”»å¸ƒå†…å®¹åˆ°é¢„è§ˆç”»å¸ƒ
        previewCtx.clearRect(0, 0, previewCanvas.width, previewCanvas.height);

        // ç»˜åˆ¶èƒŒæ™¯
        if (backgroundImage) {
          previewCtx.drawImage(backgroundImage, 0, 0, previewCanvas.width, previewCanvas.height);
        } else {
          previewCtx.fillStyle = backgroundColor;
          previewCtx.fillRect(0, 0, previewCanvas.width, previewCanvas.height);
        }

        // ç»˜åˆ¶æ‰€æœ‰å…ƒç´ ï¼ˆä¸ç»˜åˆ¶é€‰ä¸­æ¡†ï¼‰
        elements.forEach(element => {
          element.draw(previewCtx);
        });

        // æ˜¾ç¤ºé¢„è§ˆæ¨¡æ€æ¡†
        previewModal.classList.add('active');
      }

      function closePreview() {
        const previewModal = document.getElementById('previewModal');
        previewModal.classList.remove('active');
      }

      // ç»‘å®šé¢„è§ˆå…³é—­äº‹ä»¶
      const previewCloseHandler = (e) => {
        e.preventDefault();
        e.stopPropagation();
        closePreview();
      };
      document.getElementById('previewClose').addEventListener('click', previewCloseHandler);
      document.getElementById('previewClose').addEventListener('touchstart', previewCloseHandler, { passive: false });

      const previewModalHandler = (e) => {
        if (e.target.id === 'previewModal') {
          e.preventDefault();
          closePreview();
        }
      };
      document.getElementById('previewModal').addEventListener('click', previewModalHandler);
      document.getElementById('previewModal').addEventListener('touchstart', previewModalHandler, { passive: false });

      // ESCé”®å…³é—­é¢„è§ˆ
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          closePreview();
        }
      });

      // ========== ç§»åŠ¨ç«¯æŠ½å±‰æ§åˆ¶ ==========
      function initMobileDrawers() {
        const toolDrawer = document.getElementById('toolDrawer');
        const propsDrawer = document.getElementById('propsDrawer');
        const overlay = document.getElementById('drawerOverlay');
        const mobileFabTools = document.getElementById('mobileFabTools');
        const mobileFabProps = document.getElementById('mobileFabProps');
        const closeToolDrawer = document.getElementById('closeToolDrawer');
        const closePropsDrawer = document.getElementById('closePropsDrawer');

        // æ‰“å¼€å·¥å…·æŠ½å±‰
        if (mobileFabTools) {
          const openToolDrawer = (e) => {
            e.preventDefault();
            e.stopPropagation();
            toolDrawer.classList.add('active');
            overlay.classList.add('active');
            document.body.classList.add('drawer-open');
          };

          mobileFabTools.addEventListener('click', openToolDrawer);
          mobileFabTools.addEventListener('touchstart', openToolDrawer, { passive: false });
        }

        // æ‰“å¼€å±æ€§æŠ½å±‰
        if (mobileFabProps) {
          const openPropsDrawer = (e) => {
            e.preventDefault();
            e.stopPropagation();
            propsDrawer.classList.add('active');
            overlay.classList.add('active');
            document.body.classList.add('drawer-open');
          };

          mobileFabProps.addEventListener('click', openPropsDrawer);
          mobileFabProps.addEventListener('touchstart', openPropsDrawer, { passive: false });
        }

        // å…³é—­æŠ½å±‰çš„å‡½æ•°
        function closeDrawers(e) {
          if (e) {
            e.preventDefault();
            e.stopPropagation();
          }
          toolDrawer.classList.remove('active');
          propsDrawer.classList.remove('active');
          overlay.classList.remove('active');
          document.body.classList.remove('drawer-open');
        }

        // å…³é—­å·¥å…·æŠ½å±‰
        if (closeToolDrawer) {
          const closeToolHandler = (e) => closeDrawers(e);
          closeToolDrawer.addEventListener('click', closeToolHandler);
          closeToolDrawer.addEventListener('touchstart', closeToolHandler, { passive: false });
        }

        // å…³é—­å±æ€§æŠ½å±‰
        if (closePropsDrawer) {
          const closePropsHandler = (e) => closeDrawers(e);
          closePropsDrawer.addEventListener('click', closePropsHandler);
          closePropsDrawer.addEventListener('touchstart', closePropsHandler, { passive: false });
        }

        // ç‚¹å‡»é®ç½©å±‚å…³é—­
        if (overlay) {
          const overlayHandler = (e) => closeDrawers(e);
          overlay.addEventListener('click', overlayHandler);
          overlay.addEventListener('touchstart', overlayHandler, { passive: false });
        }

        // ç»‘å®šç§»åŠ¨ç«¯å·¥å…·æŒ‰é’®äº‹ä»¶ï¼ˆå¤ç”¨æ¡Œé¢ç«¯é€»è¾‘ï¼‰
        bindMobileToolEvents();
      }

      // ç»‘å®šç§»åŠ¨ç«¯å·¥å…·æŒ‰é’®äº‹ä»¶
      function bindMobileToolEvents() {
        // è·å–å…³é—­æŠ½å±‰å‡½æ•°çš„å¼•ç”¨
        const toolDrawer = document.getElementById('toolDrawer');
        const propsDrawer = document.getElementById('propsDrawer');
        const overlay = document.getElementById('drawerOverlay');

        const closeAllDrawers = () => {
          toolDrawer.classList.remove('active');
          propsDrawer.classList.remove('active');
          overlay.classList.remove('active');
          document.body.classList.remove('drawer-open');
        };

        // è¾…åŠ©å‡½æ•°ï¼šä¸ºæŒ‰é’®ç»‘å®š click å’Œ touchstart äº‹ä»¶
        const bindButtonEvents = (id, handler) => {
          const btn = document.getElementById(id);
          if (btn) {
            const wrappedHandler = (e) => {
              e.preventDefault();
              e.stopPropagation();
              handler(e);
            };
            btn.addEventListener('click', wrappedHandler);
            btn.addEventListener('touchstart', wrappedHandler, { passive: false });
          }
        };

        // ç”»å¸ƒå°ºå¯¸é¢„è®¾
        const mobilePresets = document.querySelectorAll('.mobile-preset');
        mobilePresets.forEach((btn, index) => {
          const handler = function(e) {
            e.preventDefault();
            e.stopPropagation();
            const [width, height] = this.dataset.size.split(',').map(Number);
            canvas.width = width;
            canvas.height = height;
            document.querySelectorAll('.mobile-preset').forEach(b => b.classList.remove('active'));
            this.classList.add('active');
            adjustCanvasSize();
            render();
            showToast(`ç”»å¸ƒå°ºå¯¸å·²è°ƒæ•´ä¸º ${width}Ã—${height}`, 'success');
            closeAllDrawers();
          };
          btn.addEventListener('click', handler);
          btn.addEventListener('touchstart', handler, { passive: false });
        });

        // èƒŒæ™¯è®¾ç½®
        bindButtonEvents('mobileBgColor', () => {
          document.getElementById('setBgColor').click();
          closeAllDrawers();
        });

        bindButtonEvents('mobileUploadBg', () => {
          document.getElementById('uploadBgImage').click();
          closeAllDrawers();
        });

        // æ·»åŠ å…ƒç´ 
        bindButtonEvents('mobileAddText', () => {
          document.getElementById('addText').click();
          closeAllDrawers();
        });

        bindButtonEvents('mobileUploadImage', () => {
          document.getElementById('uploadImage').click();
          closeAllDrawers();
        });

        bindButtonEvents('mobileAddRect', () => {
          document.getElementById('addRect').click();
          closeAllDrawers();
        });

        bindButtonEvents('mobileAddCircle', () => {
          document.getElementById('addCircle').click();
          closeAllDrawers();
        });

        // æ–‡ä»¶æ“ä½œ
        bindButtonEvents('mobileClear', () => {
          document.getElementById('clearCanvas').click();
          closeAllDrawers();
        });

        bindButtonEvents('mobileExportPNG', () => {
          document.getElementById('exportPNG').click();
          closeAllDrawers();
        });

        bindButtonEvents('mobileExportJPG', () => {
          document.getElementById('exportJPG').click();
          closeAllDrawers();
        });

        // åˆ é™¤å…ƒç´ 
        bindButtonEvents('mobileDeleteElement', () => {
          if (selectedElement) {
            const index = elements.indexOf(selectedElement);
            if (index !== -1) {
              deleteLayer(index);
              closeAllDrawers();
            }
          } else {
            showToast('è¯·å…ˆé€‰æ‹©è¦åˆ é™¤çš„å…ƒç´ ', 'warning');
          }
        });


        // ç§»åŠ¨ç«¯å±æ€§è¾“å…¥ç»‘å®šï¼ˆåŒæ­¥åˆ°æ¡Œé¢ç«¯ï¼‰
        syncMobileProperties();
      }

      // åŒæ­¥ç§»åŠ¨ç«¯å’Œæ¡Œé¢ç«¯å±æ€§è¾“å…¥
      function syncMobileProperties() {
        // è¾…åŠ©å‡½æ•°ï¼šä¸ºè¾“å…¥æ¡†ç»‘å®šåŒäº‹ä»¶
        const bindInputSync = (mobileId, desktopId, eventType = 'input') => {
          const mobileEl = document.getElementById(mobileId);
          const desktopEl = document.getElementById(desktopId);

          if (!mobileEl || !desktopEl) {
            console.warn(`å…ƒç´ æœªæ‰¾åˆ°: ${mobileId} æˆ– ${desktopId}`);
            return;
          }

          const handler = () => {
            desktopEl.value = mobileEl.value;
            desktopEl.dispatchEvent(new Event(eventType));
          };

          mobileEl.addEventListener(eventType, handler);
          // ä¸ºæŸäº›å¯èƒ½éœ€è¦çš„å…ƒç´ æ·»åŠ  change äº‹ä»¶
          if (eventType === 'input' && (mobileEl.type === 'number' || mobileEl.type === 'color')) {
            mobileEl.addEventListener('change', handler);
          }
        };

        // è¾…åŠ©å‡½æ•°ï¼šä¸ºé¢œè‰²é€‰æ‹©å™¨ç»‘å®šåŒäº‹ä»¶
        const bindColorPickerSync = (mobileId, desktopId) => {
          const mobileEl = document.getElementById(mobileId);
          const desktopEl = document.getElementById(desktopId);

          if (!mobileEl || !desktopEl) {
            console.warn(`é¢œè‰²é€‰æ‹©å™¨æœªæ‰¾åˆ°: ${mobileId} æˆ– ${desktopId}`);
            return;
          }

          const handler = () => {
            desktopEl.value = mobileEl.value;
            desktopEl.dispatchEvent(new Event('input'));
          };

          mobileEl.addEventListener('input', handler);
          mobileEl.addEventListener('change', handler);
        };

        // æ–‡æœ¬å±æ€§
        bindInputSync('mobileTextContent', 'textContent', 'input');
        bindInputSync('mobileFontSize', 'fontSize', 'input');
        bindInputSync('mobileFontWeight', 'fontWeight', 'change');
        bindColorPickerSync('mobileTextColor', 'textColor');

        // å½¢çŠ¶å±æ€§
        bindColorPickerSync('mobileFillColor', 'fillColor');
        bindColorPickerSync('mobileStrokeColor', 'strokeColor');
        bindInputSync('mobileStrokeWidth', 'strokeWidth', 'input');

        // é€šç”¨å±æ€§
        bindInputSync('mobileElementWidth', 'elementWidth', 'input');
        bindInputSync('mobileElementHeight', 'elementHeight', 'input');
        bindInputSync('mobileElementX', 'elementX', 'input');
        bindInputSync('mobileElementY', 'elementY', 'input');
      }

      // å¯åŠ¨åº”ç”¨
      init();
      initMobileDrawers();
    </script>
  </body>
</html>
